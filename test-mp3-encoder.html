<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MP3 ç¼–ç å™¨æµ‹è¯•</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      border-radius: 3px;
    }
    .success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    audio {
      width: 100%;
      margin: 10px 0;
    }
    .stats {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸµ MP3 ç¼–ç å™¨æµ‹è¯•</h1>
    <div class="subtitle">åŸºäº lamejs çš„çœŸå® MP3 ç¼–ç </div>

    <div class="section">
      <h3>1. é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</h3>
      <input type="file" id="fileInput" accept="audio/*">
      <div class="info">
        æ”¯æŒæ ¼å¼ï¼šMP3, WAV, FLAC, M4A, OGG ç­‰æµè§ˆå™¨æ”¯æŒçš„éŸ³é¢‘æ ¼å¼
      </div>
    </div>

    <div class="section">
      <h3>2. åŸå§‹éŸ³é¢‘</h3>
      <audio id="originalAudio" controls></audio>
      <div id="originalInfo" class="stats"></div>
    </div>

    <div class="section">
      <h3>3. ç¼–ç æµ‹è¯•</h3>
      <button id="encodeBtn" disabled>ç¼–ç ä¸º MP3 (320kbps)</button>
      <div id="encodeStatus"></div>
    </div>

    <div class="section">
      <h3>4. ç¼–ç åçš„ MP3</h3>
      <audio id="encodedAudio" controls></audio>
      <div id="encodedInfo" class="stats"></div>
      <button id="downloadBtn" disabled>ä¸‹è½½ MP3</button>
    </div>
  </div>

  <script src="node_modules/lamejs/lame.all.js"></script>
  <script>
    // å†…è” MP3 ç¼–ç å™¨ä»£ç ï¼ˆé¿å…æ¨¡å—å¯¼å…¥é—®é¢˜ï¼‰
    class Mp3Encoder {
      static encode(audioBuffer, options = {}) {
        const { bitRate = 320 } = options;
        
        const sampleRate = audioBuffer.sampleRate;
        const channels = audioBuffer.numberOfChannels;
        
        // åˆ›å»º lamejs ç¼–ç å™¨
        const encoder = new lamejs.Mp3Encoder(channels, sampleRate, bitRate);
        
        // è·å–éŸ³é¢‘æ•°æ®
        const samples = this._getChannelData(audioBuffer);
        
        // ç¼–ç 
        const mp3Data = [];
        const sampleBlockSize = 1152; // MP3 æ ‡å‡†å¸§å¤§å°
        
        if (channels === 1) {
          // å•å£°é“
          for (let i = 0; i < samples[0].length; i += sampleBlockSize) {
            const sampleChunk = samples[0].subarray(i, i + sampleBlockSize);
            const mp3buf = encoder.encodeBuffer(sampleChunk);
            if (mp3buf.length > 0) {
              mp3Data.push(mp3buf);
            }
          }
        } else {
          // ç«‹ä½“å£°
          for (let i = 0; i < samples[0].length; i += sampleBlockSize) {
            const leftChunk = samples[0].subarray(i, i + sampleBlockSize);
            const rightChunk = samples[1].subarray(i, i + sampleBlockSize);
            const mp3buf = encoder.encodeBuffer(leftChunk, rightChunk);
            if (mp3buf.length > 0) {
              mp3Data.push(mp3buf);
            }
          }
        }
        
        // åˆ·æ–°ç¼–ç å™¨ç¼“å†²åŒº
        const mp3buf = encoder.flush();
        if (mp3buf.length > 0) {
          mp3Data.push(mp3buf);
        }
        
        // åˆå¹¶æ‰€æœ‰ MP3 æ•°æ®
        const totalLength = mp3Data.reduce((acc, arr) => acc + arr.length, 0);
        const mp3Buffer = new Uint8Array(totalLength);
        let offset = 0;
        for (const chunk of mp3Data) {
          mp3Buffer.set(chunk, offset);
          offset += chunk.length;
        }
        
        // è¿”å› Blob
        return new Blob([mp3Buffer], { type: 'audio/mpeg' });
      }
      
      static _getChannelData(audioBuffer) {
        const channels = audioBuffer.numberOfChannels;
        const length = audioBuffer.length;
        const result = [];
        
        for (let ch = 0; ch < channels; ch++) {
          const float32 = audioBuffer.getChannelData(ch);
          const int16 = new Int16Array(length);
          
          for (let i = 0; i < length; i++) {
            const s = Math.max(-1, Math.min(1, float32[i]));
            int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }
          
          result.push(int16);
        }
        
        return result;
      }
    }

    const fileInput = document.getElementById('fileInput');
    const originalAudio = document.getElementById('originalAudio');
    const originalInfo = document.getElementById('originalInfo');
    const encodeBtn = document.getElementById('encodeBtn');
    const encodeStatus = document.getElementById('encodeStatus');
    const encodedAudio = document.getElementById('encodedAudio');
    const encodedInfo = document.getElementById('encodedInfo');
    const downloadBtn = document.getElementById('downloadBtn');

    let audioBuffer = null;
    let mp3Blob = null;
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        // æ˜¾ç¤ºåŸå§‹éŸ³é¢‘
        const url = URL.createObjectURL(file);
        originalAudio.src = url;

        // è§£ç éŸ³é¢‘
        const arrayBuffer = await file.arrayBuffer();
        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // æ˜¾ç¤ºä¿¡æ¯
        originalInfo.innerHTML = `
          æ–‡ä»¶å: ${file.name}<br>
          æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB<br>
          é‡‡æ ·ç‡: ${audioBuffer.sampleRate} Hz<br>
          å£°é“æ•°: ${audioBuffer.numberOfChannels}<br>
          æ—¶é•¿: ${audioBuffer.duration.toFixed(2)} ç§’
        `;

        encodeBtn.disabled = false;
        encodeStatus.innerHTML = '<div class="info">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹ç¼–ç </div>';
      } catch (error) {
        encodeStatus.innerHTML = `<div class="error">è§£ç å¤±è´¥: ${error.message}</div>`;
      }
    });

    // ç¼–ç æŒ‰é’®
    encodeBtn.addEventListener('click', async () => {
      if (!audioBuffer) return;

      encodeBtn.disabled = true;
      const startTime = performance.now();

      try {
        encodeStatus.innerHTML = '<div class="info">æ­£åœ¨ç¼–ç ä¸­...</div>';

        // ä½¿ç”¨ MP3 ç¼–ç å™¨
        mp3Blob = Mp3Encoder.encode(audioBuffer, { bitRate: 320 });

        const endTime = performance.now();
        const encodeTime = ((endTime - startTime) / 1000).toFixed(2);
        const speedRatio = (audioBuffer.duration / (encodeTime || 0.001)).toFixed(2);

        // æ’­æ”¾ç¼–ç åçš„éŸ³é¢‘
        const url = URL.createObjectURL(mp3Blob);
        encodedAudio.src = url;

        // æ˜¾ç¤ºç¼–ç ä¿¡æ¯
        encodedInfo.innerHTML = `
          æ ¼å¼: MP3 (çœŸå®ç¼–ç )<br>
          æ¯”ç‰¹ç‡: 320 kbps<br>
          æ–‡ä»¶å¤§å°: ${(mp3Blob.size / 1024).toFixed(2)} KB<br>
          ç¼–ç æ—¶é—´: ${encodeTime} ç§’<br>
          ç¼–ç é€Ÿåº¦: ${speedRatio}x å®æ—¶é€Ÿåº¦<br>
          MIMEç±»å‹: ${mp3Blob.type}
        `;

        encodeStatus.innerHTML = `<div class="success">âœ… ç¼–ç æˆåŠŸï¼ è€—æ—¶ ${encodeTime} ç§’</div>`;
        downloadBtn.disabled = false;
      } catch (error) {
        encodeStatus.innerHTML = `<div class="error">âŒ ç¼–ç å¤±è´¥: ${error.message}</div>`;
        console.error('ç¼–ç é”™è¯¯:', error);
      } finally {
        encodeBtn.disabled = false;
      }
    });

    // ä¸‹è½½æŒ‰é’®
    downloadBtn.addEventListener('click', () => {
      if (!mp3Blob) return;

      const url = URL.createObjectURL(mp3Blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'encoded-audio.mp3';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>