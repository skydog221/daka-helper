<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç»Ÿä¸€ UI æµ‹è¯• - æ‰“å¡å‰ªè¾‘åŠ©æ‰‹</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .test-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .test-header {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .test-header h1 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .test-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .test-card h3 {
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .test-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .test-item:last-child {
        border-bottom: none;
      }

      .test-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .status-pending {
        background: #ffc107;
        color: #333;
      }

      .status-pass {
        background: #28a745;
        color: white;
      }

      .status-fail {
        background: #dc3545;
        color: white;
      }

      .run-tests-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        display: block;
        margin: 20px auto;
      }

      .run-tests-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .test-results {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: none;
      }

      .test-results.show {
        display: block;
      }

      .result-summary {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .summary-item {
        text-align: center;
      }

      .summary-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .summary-label {
        color: #666;
        font-size: 0.9rem;
      }

      .app-frame {
        background: white;
        border-radius: 15px;
        padding: 0;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .app-frame iframe {
        width: 100%;
        height: 800px;
        border: none;
      }

      .log-output {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #333;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-info {
        color: #4fc3f7;
      }

      .log-success {
        color: #81c784;
      }

      .log-error {
        color: #e57373;
      }

      .log-warn {
        color: #ffb74d;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <!-- æµ‹è¯•å¤´éƒ¨ -->
      <div class="test-header">
        <h1>ğŸ§ª ç»Ÿä¸€ UI æµ‹è¯•å¥—ä»¶</h1>
        <p>æµ‹è¯• <code>src/ui/</code> ç»Ÿä¸€æ¶æ„çš„å®Œæ•´åŠŸèƒ½</p>
      </div>

      <!-- æµ‹è¯•è®¡åˆ’ -->
      <div class="test-grid">
        <!-- æ¨¡å—åŠ è½½æµ‹è¯• -->
        <div class="test-card">
          <h3>ğŸ“¦ æ¨¡å—åŠ è½½æµ‹è¯•</h3>
          <div class="test-item">
            <span>æ ¸å¿ƒæ¨¡å—åŠ è½½</span>
            <span class="test-status status-pending" id="status-core-modules">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>ç¼–ç å™¨æ¨¡å—åŠ è½½</span>
            <span class="test-status status-pending" id="status-encoders">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>é€‚é…å™¨æ¨¡å—åŠ è½½</span>
            <span class="test-status status-pending" id="status-adapters">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>lamejs åŠ è½½</span>
            <span class="test-status status-pending" id="status-lamejs">å¾…æµ‹è¯•</span>
          </div>
        </div>

        <!-- UI åŠŸèƒ½æµ‹è¯• -->
        <div class="test-card">
          <h3>ğŸ¨ UI åŠŸèƒ½æµ‹è¯•</h3>
          <div class="test-item">
            <span>ç•Œé¢åˆå§‹åŒ–</span>
            <span class="test-status status-pending" id="status-ui-init">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>æ–‡ä»¶é€‰æ‹©åŠŸèƒ½</span>
            <span class="test-status status-pending" id="status-file-select">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>æ—¶é—´è¾“å…¥éªŒè¯</span>
            <span class="test-status status-pending" id="status-time-input">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>æ ¼å¼é€‰æ‹©å™¨</span>
            <span class="test-status status-pending" id="status-format-select">å¾…æµ‹è¯•</span>
          </div>
        </div>

        <!-- å¹³å°é€‚é…æµ‹è¯• -->
        <div class="test-card">
          <h3>ğŸ”§ å¹³å°é€‚é…æµ‹è¯•</h3>
          <div class="test-item">
            <span>å¹³å°æ£€æµ‹</span>
            <span class="test-status status-pending" id="status-platform-detect">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>é…ç½®å­˜å‚¨</span>
            <span class="test-status status-pending" id="status-config-storage">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>æ–‡ä»¶å¤„ç†</span>
            <span class="test-status status-pending" id="status-file-handler">å¾…æµ‹è¯•</span>
          </div>
        </div>

        <!-- æ ¸å¿ƒç®—æ³•æµ‹è¯• -->
        <div class="test-card">
          <h3>âš™ï¸ æ ¸å¿ƒç®—æ³•æµ‹è¯•</h3>
          <div class="test-item">
            <span>æ—¶é—´è®¡ç®—</span>
            <span class="test-status status-pending" id="status-time-calc">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>éšæœºå»¶é•¿é€»è¾‘</span>
            <span class="test-status status-pending" id="status-random-extend">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>è¾“å…¥éªŒè¯</span>
            <span class="test-status status-pending" id="status-validation">å¾…æµ‹è¯•</span>
          </div>
          <div class="test-item">
            <span>æ ¼å¼æ£€æµ‹</span>
            <span class="test-status status-pending" id="status-format-detect">å¾…æµ‹è¯•</span>
          </div>
        </div>
      </div>

      <!-- è¿è¡Œæµ‹è¯•æŒ‰é’® -->
      <button class="run-tests-btn" onclick="runAllTests()">
        ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•
      </button>

      <!-- æµ‹è¯•ç»“æœæ‘˜è¦ -->
      <div class="test-results" id="testResults">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div class="result-summary">
          <div class="summary-item">
            <div class="summary-number" style="color: #28a745" id="passCount">0</div>
            <div class="summary-label">é€šè¿‡</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #dc3545" id="failCount">0</div>
            <div class="summary-label">å¤±è´¥</div>
          </div>
          <div class="summary-item">
            <div class="summary-number" style="color: #667eea" id="totalCount">0</div>
            <div class="summary-label">æ€»è®¡</div>
          </div>
        </div>
        <div class="log-output" id="logOutput"></div>
      </div>

      <!-- åº”ç”¨é¢„è§ˆ -->
      <div class="test-card" style="margin-top: 20px;">
        <h3>ğŸ“± åº”ç”¨é¢„è§ˆ</h3>
        <div class="app-frame">
          <iframe src="src/ui/index.html" id="appFrame"></iframe>
        </div>
      </div>
    </div>

    <script type="module">
      // æµ‹è¯•ç»“æœå­˜å‚¨
      const testResults = {
        passed: 0,
        failed: 0,
        total: 0
      };

      // æ—¥å¿—è¾“å‡º
      function log(message, type = 'info') {
        const logOutput = document.getElementById('logOutput');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logOutput.appendChild(entry);
        logOutput.scrollTop = logOutput.scrollHeight;
      }

      // æ›´æ–°æµ‹è¯•çŠ¶æ€
      function updateStatus(testId, passed, message = '') {
        const element = document.getElementById(`status-${testId}`);
        element.className = `test-status ${passed ? 'status-pass' : 'status-fail'}`;
        element.textContent = passed ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥';
        
        testResults.total++;
        if (passed) {
          testResults.passed++;
          log(`âœ“ ${testId}: ${message || 'æµ‹è¯•é€šè¿‡'}`, 'success');
        } else {
          testResults.failed++;
          log(`âœ— ${testId}: ${message || 'æµ‹è¯•å¤±è´¥'}`, 'error');
        }
        
        updateSummary();
      }

      // æ›´æ–°æ‘˜è¦
      function updateSummary() {
        document.getElementById('passCount').textContent = testResults.passed;
        document.getElementById('failCount').textContent = testResults.failed;
        document.getElementById('totalCount').textContent = testResults.total;
      }

      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      window.runAllTests = async function() {
        // é‡ç½®
        testResults.passed = 0;
        testResults.failed = 0;
        testResults.total = 0;
        document.getElementById('logOutput').innerHTML = '';
        document.getElementById('testResults').classList.add('show');
        
        log('å¼€å§‹è¿è¡Œæµ‹è¯•å¥—ä»¶...', 'info');
        
        // æ¨¡å—åŠ è½½æµ‹è¯•
        await testModuleLoading();
        
        // UI åŠŸèƒ½æµ‹è¯•
        await testUIFunctions();
        
        // å¹³å°é€‚é…æµ‹è¯•
        await testPlatformAdapters();
        
        // æ ¸å¿ƒç®—æ³•æµ‹è¯•
        await testCoreAlgorithms();
        
        log(`æµ‹è¯•å®Œæˆï¼é€šè¿‡: ${testResults.passed}, å¤±è´¥: ${testResults.failed}`, 'info');
      };

      // 1. æ¨¡å—åŠ è½½æµ‹è¯•
      async function testModuleLoading() {
        log('=== æ¨¡å—åŠ è½½æµ‹è¯• ===', 'info');
        
        // æµ‹è¯•æ ¸å¿ƒæ¨¡å—
        try {
          const { TimeCalculator } = await import('./src/core/time-calculator.js');
          const { Validator } = await import('./src/core/validator.js');
          const { AudioRepeater } = await import('./src/core/audio-repeater.js');
          const { FormatDetector } = await import('./src/core/format-detector.js');
          
          updateStatus('core-modules', 
            TimeCalculator && Validator && AudioRepeater && FormatDetector,
            'æ‰€æœ‰æ ¸å¿ƒæ¨¡å—åŠ è½½æˆåŠŸ'
          );
        } catch (error) {
          updateStatus('core-modules', false, error.message);
        }
        
        // æµ‹è¯•ç¼–ç å™¨æ¨¡å—
        try {
          const { WavEncoder } = await import('./src/encoders/wav-encoder.js');
          const { Mp3Encoder } = await import('./src/encoders/mp3-encoder.js');
          const { AudioEncoder } = await import('./src/encoders/audio-encoder.js');
          
          updateStatus('encoders', 
            WavEncoder && Mp3Encoder && AudioEncoder,
            'æ‰€æœ‰ç¼–ç å™¨æ¨¡å—åŠ è½½æˆåŠŸ'
          );
        } catch (error) {
          updateStatus('encoders', false, error.message);
        }
        
        // æµ‹è¯•é€‚é…å™¨æ¨¡å—
        try {
          const { PlatformDetector } = await import('./src/adapters/platform-detector.js');
          const { getConfigStorage } = await import('./src/adapters/config-storage.js');
          const { getFileHandler } = await import('./src/adapters/file-handler.js');
          
          updateStatus('adapters', 
            PlatformDetector && getConfigStorage && getFileHandler,
            'æ‰€æœ‰é€‚é…å™¨æ¨¡å—åŠ è½½æˆåŠŸ'
          );
        } catch (error) {
          updateStatus('adapters', false, error.message);
        }
        
        // æµ‹è¯• lamejs
        updateStatus('lamejs', 
          typeof window.lamejs !== 'undefined',
          window.lamejs ? 'lamejs åŠ è½½æˆåŠŸ' : 'lamejs æœªåŠ è½½'
        );
      }

      // 2. UI åŠŸèƒ½æµ‹è¯•
      async function testUIFunctions() {
        log('=== UI åŠŸèƒ½æµ‹è¯• ===', 'info');
        
        const iframe = document.getElementById('appFrame');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        // ç­‰å¾… iframe åŠ è½½
        await new Promise(resolve => {
          if (iframe.contentWindow.document.readyState === 'complete') {
            resolve();
          } else {
            iframe.onload = resolve;
          }
        });
        
        // æµ‹è¯•ç•Œé¢åˆå§‹åŒ–
        const requiredElements = [
          'fileUploadArea',
          'selectFileBtn',
          'targetMinutes',
          'targetSeconds',
          'randomExtend',
          'randomRange',
          'outputFormat',
          'processBtn'
        ];
        
        const allElementsExist = requiredElements.every(id => 
          iframeDoc.getElementById(id) !== null
        );
        
        updateStatus('ui-init', allElementsExist, 
          allElementsExist ? 'æ‰€æœ‰å¿…éœ€å…ƒç´ å­˜åœ¨' : 'ç¼ºå°‘å¿…éœ€å…ƒç´ '
        );
        
        // æµ‹è¯•æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
        const selectBtn = iframeDoc.getElementById('selectFileBtn');
        updateStatus('file-select', 
          selectBtn !== null && selectBtn.onclick !== undefined,
          'æ–‡ä»¶é€‰æ‹©æŒ‰é’®å¯ç”¨'
        );
        
        // æµ‹è¯•æ—¶é—´è¾“å…¥
        const minutesInput = iframeDoc.getElementById('targetMinutes');
        const secondsInput = iframeDoc.getElementById('targetSeconds');
        updateStatus('time-input', 
          minutesInput && secondsInput && 
          minutesInput.type === 'number' && secondsInput.type === 'number',
          'æ—¶é—´è¾“å…¥å­—æ®µæ­£ç¡®é…ç½®'
        );
        
        // æµ‹è¯•æ ¼å¼é€‰æ‹©å™¨
        const formatSelect = iframeDoc.getElementById('outputFormat');
        const options = Array.from(formatSelect.options).map(opt => opt.value);
        updateStatus('format-select', 
          options.includes('mp3') && options.includes('wav') && options.length === 2,
          `æ ¼å¼é€‰é¡¹: ${options.join(', ')}`
        );
      }

      // 3. å¹³å°é€‚é…æµ‹è¯•
      async function testPlatformAdapters() {
        log('=== å¹³å°é€‚é…æµ‹è¯• ===', 'info');
        
        try {
          const { PlatformDetector } = await import('./src/adapters/platform-detector.js');
          const platformInfo = PlatformDetector.getPlatformInfo();
          
          updateStatus('platform-detect', 
            platformInfo && platformInfo.platform,
            `æ£€æµ‹åˆ°å¹³å°: ${platformInfo.platform}`
          );
        } catch (error) {
          updateStatus('platform-detect', false, error.message);
        }
        
        try {
          const { getConfigStorage } = await import('./src/adapters/config-storage.js');
          const config = getConfigStorage();
          
          // æµ‹è¯•ä¿å­˜å’Œè¯»å–
          config.set('test-key', 'test-value');
          const value = config.get('test-key');
          config.set('test-key', null); // æ¸…ç†
          
          updateStatus('config-storage', 
            value === 'test-value',
            'é…ç½®å­˜å‚¨è¯»å†™æ­£å¸¸'
          );
        } catch (error) {
          updateStatus('config-storage', false, error.message);
        }
        
        try {
          const { getFileHandler } = await import('./src/adapters/file-handler.js');
          const fileHandler = getFileHandler();
          
          updateStatus('file-handler', 
            fileHandler && typeof fileHandler.validateFileType === 'function',
            'æ–‡ä»¶å¤„ç†å™¨åˆå§‹åŒ–æˆåŠŸ'
          );
        } catch (error) {
          updateStatus('file-handler', false, error.message);
        }
      }

      // 4. æ ¸å¿ƒç®—æ³•æµ‹è¯•
      async function testCoreAlgorithms() {
        log('=== æ ¸å¿ƒç®—æ³•æµ‹è¯• ===', 'info');
        
        // æ—¶é—´è®¡ç®—æµ‹è¯•
        try {
          const { TimeCalculator } = await 