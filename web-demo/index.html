<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰“å¡å‰ªè¾‘åŠ©æ‰‹ - Demo</title>
    <style>
      /* å…¨å±€æ ·å¼ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* æ ‡é¢˜æ æ ·å¼ */
      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
      }

      /* ä¸»è¦å†…å®¹åŒºåŸŸ */
      .main-content {
        flex: 1;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      /* æ–‡ä»¶é€‰æ‹©åŒºåŸŸ */
      .file-section {
        margin-bottom: 30px;
      }

      .file-upload-area {
        border: 3px dashed #ddd;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafafa;
      }

      .file-upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .upload-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .upload-hint {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      .select-file-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .select-file-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      /* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º */
      .file-info {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid #e9ecef;
      }

      .file-details h3 {
        color: #333;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }

      .file-meta {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #666;
      }

      .file-meta span {
        background: white;
        padding: 4px 12px;
        border-radius: 20px;
        border: 1px solid #ddd;
      }

      .change-file-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .change-file-btn:hover {
        background: #5a6268;
      }

      /* è®¾ç½®åŒºåŸŸ */
      .settings-section {
        margin-bottom: 30px;
      }

      .settings-section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .setting-group {
        margin-bottom: 20px;
      }

      .setting-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .time-input-group {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .time-input-group input {
        flex: 0 0 150px;
      }

      .time-hint,
      .range-hint {
        color: #666;
        font-size: 0.85rem;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        transform: scale(1.2);
      }

      .checkbox-group label {
        margin-bottom: 0;
        cursor: pointer;
      }

      .random-range-group {
        margin-left: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      /* å¤„ç†æŒ‰é’®å’Œè¿›åº¦ */
      .process-section {
        text-align: center;
      }

      .process-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 auto 20px;
      }

      .process-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
      }

      .process-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-icon {
        font-size: 1.2rem;
      }

      /* è¿›åº¦æ˜¾ç¤º */
      .progress-container {
        max-width: 400px;
        margin: 0 auto 20px;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 600;
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
      }

      /* ç»“æœæ˜¾ç¤º */
      .result-container,
      .error-container {
        max-width: 400px;
        margin: 0 auto;
      }

      .result-success,
      .error-message {
        background: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .success-icon,
      .error-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .result-success h3,
      .error-message h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.3rem;
      }

      .result-success p,
      .error-message p {
        color: #666;
        margin-bottom: 20px;
      }

      .result-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .result-btn,
      .error-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .result-btn.secondary {
        background: #6c757d;
      }

      .result-btn:hover,
      .error-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      /* åº•éƒ¨ä¿¡æ¯ */
      .footer {
        text-align: center;
        color: white;
        opacity: 0.8;
        font-size: 0.9rem;
      }

      .footer-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
      }

      .github-btn {
        background: #333;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .github-btn:hover {
        background: #555;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .diff-btn {
        background: #007bff; /* è“è‰² */
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .diff-btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .main-content {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .file-upload-area {
          padding: 30px 15px;
        }

        .file-info {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .file-meta {
          justify-content: center;
          flex-wrap: wrap;
        }

        .time-input-group {
          flex-direction: column;
          align-items: flex-start;
        }

        .result-actions {
          flex-direction: column;
        }
      }

      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-info,
      .progress-container,
      .result-container,
      .error-container {
        animation: fadeIn 0.5s ease;
      }

      /* å¼¹çª—æ ·å¼ */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        text-align: left;
        position: relative;
        animation: slideIn 0.3s ease-out;
      }

      .modal-content h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.4rem;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .modal-content ul {
        list-style: disc;
        margin-left: 20px;
        margin-bottom: 20px;
        color: #555;
      }

      .modal-content ul li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      .modal-close-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        display: block;
        margin: 0 auto;
      }

      .modal-close-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- æ ‡é¢˜æ  -->
      <header class="header">
        <h1>ğŸµ æ‰“å¡å‰ªè¾‘åŠ©æ‰‹</h1>
        <p class="subtitle">å¿«é€Ÿé‡å¤æ‹¼æ¥éŸ³é¢‘åˆ°æŒ‡å®šæ—¶é—´</p>
      </header>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
      <main class="main-content">
        <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
        <section class="file-section">
          <div class="file-upload-area" id="fileUploadArea">
            <div class="upload-icon">ğŸ“</div>
            <p class="upload-text">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</p>
            <p class="upload-hint">æ”¯æŒ MP3ã€WAVã€FLACã€M4Aã€AACã€OGG æ ¼å¼</p>
            <button class="select-file-btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
          </div>

          <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
          <div class="file-info" id="fileInfo" style="display: none">
            <div class="file-details">
              <h3 id="fileName">æ–‡ä»¶å</h3>
              <div class="file-meta">
                <span id="fileSize">æ–‡ä»¶å¤§å°</span>
                <span id="fileDuration">æ—¶é•¿</span>
                <span id="fileFormat">æ ¼å¼</span>
              </div>
            </div>
            <button class="change-file-btn" id="changeFileBtn">æ›´æ¢æ–‡ä»¶</button>
          </div>
        </section>

        <!-- è®¾ç½®åŒºåŸŸ -->
        <section class="settings-section">
          <h2>å¤„ç†è®¾ç½®</h2>

          <!-- ç›®æ ‡æ—¶é—´è®¾ç½® -->
          <div class="setting-group">
            <label for="targetTime">ç›®æ ‡æ—¶é•¿</label>
            <div class="time-input-group">
              <input
                type="text"
                id="targetTime"
                placeholder="MM:SS æˆ– HH:MM:SS"
                value="10:00"
              />
              <span class="time-hint">æ ¼å¼ï¼šåˆ†:ç§’ æˆ– æ—¶:åˆ†:ç§’</span>
            </div>
          </div>

          <!-- éšæœºå»¶é•¿è®¾ç½® -->
          <div class="setting-group">
            <div class="checkbox-group">
              <input type="checkbox" id="randomExtend" checked />
              <label for="randomExtend">éšæœºå»¶é•¿</label>
            </div>
            <div
              class="random-range-group"
              id="randomRangeGroup"
              style="display: block"
            >
              <label for="randomRange">å»¶é•¿èŒƒå›´ï¼ˆç§’ï¼‰</label>
              <input
                type="number"
                id="randomRange"
                min="1"
                max="300"
                value="30"
              />
              <span class="range-hint">åœ¨ç›®æ ‡æ—¶é•¿åŸºç¡€ä¸Šéšæœºå¢åŠ  0-30 ç§’</span>
            </div>
          </div>

          <!-- è¾“å‡ºæ ¼å¼è®¾ç½® -->
          <div class="setting-group">
            <label for="outputFormat">è¾“å‡ºæ ¼å¼</label>
            <select id="outputFormat">
              <option value="m4a">M4A (æ¨è)</option>
              <option value="wav">WAV (æ— æŸ)</option>
              <option value="mp3">MP3</option>
              <option value="flac">FLAC (æ— æŸå‹ç¼©)</option>
              <option value="aac">AAC</option>
            </select>
          </div>
        </section>

        <!-- å¤„ç†æŒ‰é’®å’Œè¿›åº¦ -->
        <section class="process-section">
          <button class="process-btn" id="processBtn" disabled>
            <span class="btn-icon">ğŸš€</span>
            <span class="btn-text">å¼€å§‹å¤„ç†</span>
          </button>

          <!-- è¿›åº¦æ˜¾ç¤º -->
          <div
            class="progress-container"
            id="progressContainer"
            style="display: none"
          >
            <div class="progress-info">
              <span id="progressStage">å‡†å¤‡ä¸­...</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <!-- ç»“æœæ˜¾ç¤º -->
          <div
            class="result-container"
            id="resultContainer"
            style="display: none"
          >
            <div class="result-success">
              <div class="success-icon">âœ…</div>
              <h3>å¤„ç†å®Œæˆï¼</h3>
              <p id="resultMessage">éŸ³é¢‘æ–‡ä»¶å·²æˆåŠŸå¤„ç†</p>
              <div class="result-actions">
                <button class="result-btn" id="openFolderBtn">
                  æ‰“å¼€æ–‡ä»¶å¤¹
                </button>
                <button class="result-btn secondary" id="processAnotherBtn">
                  å¤„ç†å…¶ä»–æ–‡ä»¶
                </button>
              </div>
            </div>
          </div>

          <!-- é”™è¯¯æ˜¾ç¤º -->
          <div
            class="error-container"
            id="errorContainer"
            style="display: none"
          >
            <div class="error-message">
              <div class="error-icon">âŒ</div>
              <h3>å¤„ç†å¤±è´¥</h3>
              <p id="errorMessage">å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯</p>
              <button class="error-btn" id="retryBtn">é‡è¯•</button>
            </div>
          </div>
        </section>
      </main>

      <!-- åŒºåˆ«å¼¹çª— -->
      <div class="modal-overlay" id="diffModalOverlay" style="display: none">
        <div class="modal-content">
          <h3>æ¡Œé¢ç‰ˆä¸ç½‘é¡µDemoçš„åŒºåˆ«</h3>
          <p>æ­¤ Demo ç‰ˆæœ¬æ˜¯çº¯å‰ç«¯å®ç°ï¼Œä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>
          <ul>
            <li>
              æ–‡ä»¶æ“ä½œï¼š
              æ— æ³•ç›´æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œæ–‡ä»¶é€‰æ‹©å’Œä¿å­˜é€šè¿‡æµè§ˆå™¨å†…ç½®çš„æ–‡ä»¶ API
              å®ç°ï¼ˆæ–‡ä»¶å°†è‡ªåŠ¨ä¸‹è½½åˆ°æ‚¨çš„é»˜è®¤ä¸‹è½½ç›®å½•ï¼‰ã€‚
            </li>
            <li>
              éŸ³é¢‘ç¼–ç ï¼š æµè§ˆå™¨ç¯å¢ƒä¸‹çš„éŸ³é¢‘ç¼–ç èƒ½åŠ›æœ‰é™ï¼Œç›®å‰é™¤ WAV
              å¤–ï¼Œå…¶ä»–æ ¼å¼ï¼ˆM4A, MP3, FLAC, AACï¼‰çš„è¾“å‡ºæ–‡ä»¶å®é™…å†…å®¹ä»ä¸º
              WAVï¼Œä»…ä¿®æ”¹äº†æ–‡ä»¶æ‰©å±•åå’Œ MIME ç±»å‹ã€‚Electron ç‰ˆæœ¬å¯ä»¥åˆ©ç”¨ FFmpeg
              è¿›è¡Œæ›´ä¸“ä¸šçš„ç¼–ç ã€‚
            </li>
            <li>ç³»ç»Ÿé›†æˆï¼š æ— æ³•å®ç°å¦‚â€œæ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹â€ç­‰ç³»ç»Ÿçº§æ“ä½œã€‚</li>
          </ul>
          <button class="modal-close-btn" id="closeDiffModalBtn">å…³é—­</button>
        </div>
      </div>

      <!-- åº•éƒ¨ä¿¡æ¯ -->
      <footer class="footer">
        <p>Â© 2025 æ‰“å¡å‰ªè¾‘åŠ©æ‰‹ - è®©éŸ³é¢‘å¤„ç†æ›´ç®€å•</p>
        <div class="footer-actions">
          <button class="github-btn" id="githubRepoBtn">
            å‰å¾€ GitHub ä»“åº“
          </button>
          <button class="diff-btn" id="showDiffBtn">
            æ¡Œé¢ç‰ˆä¸ç½‘é¡µDemoçš„åŒºåˆ«
          </button>
        </div>
      </footer>
    </div>

    <script>
      // window.utils content from preload.js
      const utils = {
        /**
         * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
         * @param {number} bytes - å­—èŠ‚æ•°
         * @returns {string} æ ¼å¼åŒ–çš„æ–‡ä»¶å¤§å°
         */
        formatFileSize: (bytes) => {
          if (bytes === 0) return "0 Bytes";

          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));

          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        },

        /**
         * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
         * @param {number} seconds - ç§’æ•°
         * @returns {string} æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
         */
        formatTime: (seconds) => {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = Math.floor(seconds % 60);

          if (hours > 0) {
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          } else {
            return `${minutes.toString().padStart(2, "0")}:${secs
              .toString()
              .padStart(2, "0")}`;
          }
        },

        /**
         * è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºç§’æ•°
         * @param {string} timeString - æ—¶é—´å­—ç¬¦ä¸² (HH:MM:SS æˆ– MM:SS)
         * @returns {number} ç§’æ•°
         */
        parseTime: (timeString) => {
          const parts = timeString.split(":").map((part) => parseInt(part, 10));

          if (parts.length === 3) {
            // HH:MM:SS
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
          } else if (parts.length === 2) {
            // MM:SS
            return parts[0] * 60 + parts[1];
          } else if (parts.length === 1) {
            // SS
            return parts[0];
          }

          return 0;
        },

        /**
         * éªŒè¯æ—¶é—´æ ¼å¼
         * @param {string} timeString - æ—¶é—´å­—ç¬¦ä¸²
         * @returns {boolean} æ˜¯å¦æœ‰æ•ˆ
         */
        isValidTimeFormat: (timeString) => {
          const timeRegex = /^(\d{1,2}:)?(\d{1,2}):(\d{1,2})$/;
          return timeRegex.test(timeString);
        },
      };

      // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ç›´æ¥å°† utils æŒ‚è½½åˆ° window å¯¹è±¡
      window.utils = utils;
    </script>
    <script>
      /**
       * æ¸²æŸ“è¿›ç¨‹ä¸»è¦ JavaScript æ–‡ä»¶
       * å¤„ç†ç”¨æˆ·ç•Œé¢äº¤äº’å’ŒéŸ³é¢‘å¤„ç†ï¼ˆä½¿ç”¨ Web Audio APIï¼‰
       */

      // éŸ³é¢‘ä¸Šä¸‹æ–‡å’ŒçŠ¶æ€
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
      let originalBuffer = null;

      // åº”ç”¨çŠ¶æ€
      let appState = {
        selectedFile: null,
        audioInfo: null,
        isProcessing: false,
        outputPath: null,
      };

      // DOM å…ƒç´ å¼•ç”¨
      const elements = {
        fileUploadArea: document.getElementById("fileUploadArea"),
        selectFileBtn: document.getElementById("selectFileBtn"),
        fileInfo: document.getElementById("fileInfo"),
        fileName: document.getElementById("fileName"),
        fileSize: document.getElementById("fileSize"),
        fileDuration: document.getElementById("fileDuration"),
        fileFormat: document.getElementById("fileFormat"),
        changeFileBtn: document.getElementById("changeFileBtn"),

        targetTime: document.getElementById("targetTime"),
        randomExtend: document.getElementById("randomExtend"),
        randomRangeGroup: document.getElementById("randomRangeGroup"),
        randomRange: document.getElementById("randomRange"),
        outputFormat: document.getElementById("outputFormat"),

        processBtn: document.getElementById("processBtn"),
        progressContainer: document.getElementById("progressContainer"),
        progressStage: document.getElementById("progressStage"),
        progressPercent: document.getElementById("progressPercent"),
        progressFill: document.getElementById("progressFill"),

        resultContainer: document.getElementById("resultContainer"),
        resultMessage: document.getElementById("resultMessage"),
        openFolderBtn: document.getElementById("openFolderBtn"),
        processAnotherBtn: document.getElementById("processAnotherBtn"),

        errorContainer: document.getElementById("errorContainer"),
        errorMessage: document.getElementById("errorMessage"),
        retryBtn: document.getElementById("retryBtn"),

        // æ–°å¢çš„ DOM å¼•ç”¨
        githubRepoBtn: document.getElementById("githubRepoBtn"),
        diffModalOverlay: document.getElementById("diffModalOverlay"),
        showDiffBtn: document.getElementById("showDiffBtn"),
        closeDiffModalBtn: document.getElementById("closeDiffModalBtn"),
      };

      /**
       * åˆå§‹åŒ–åº”ç”¨
       */
      function initApp() {
        setupEventListeners();
        updateUI();
      }

      /**
       * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
       */
      function setupEventListeners() {
        // æ–‡ä»¶é€‰æ‹©ç›¸å…³
        elements.selectFileBtn.addEventListener("click", selectFile);
        elements.changeFileBtn.addEventListener("click", selectFile);
        // ç§»é™¤ä¸Šä¼ åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ä¸æŒ‰é’®ç‚¹å‡»é‡å¤è§¦å‘
        // elements.fileUploadArea.addEventListener("click", selectFile);

        // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
        elements.fileUploadArea.addEventListener("dragover", handleDragOver);
        elements.fileUploadArea.addEventListener("drop", handleDrop);

        // è®¾ç½®ç›¸å…³
        elements.randomExtend.addEventListener("change", toggleRandomRange);
        elements.targetTime.addEventListener("input", validateTimeInput);

        // å¤„ç†æŒ‰é’®
        elements.processBtn.addEventListener("click", processAudio);

        // ç»“æœæ“ä½œ
        elements.openFolderBtn.addEventListener("click", openOutputFolder);
        elements.processAnotherBtn.addEventListener("click", resetApp);
        elements.retryBtn.addEventListener("click", processAudio);

        // æ–°å¢çš„äº‹ä»¶ç›‘å¬
        elements.githubRepoBtn.addEventListener("click", () => {
          window.open("https://github.com/skydog221/daka-helper", "_blank");
        });

        elements.showDiffBtn.addEventListener("click", showDiffModal);
        elements.closeDiffModalBtn.addEventListener("click", hideDiffModal);
        elements.diffModalOverlay.addEventListener("click", (e) => {
          if (e.target === elements.diffModalOverlay) {
            hideDiffModal();
          }
        });
      }

      /**
       * é€‰æ‹©éŸ³é¢‘æ–‡ä»¶
       */
      async function selectFile() {
        try {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "audio/*";

          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 100 * 1024 * 1024) {
              // 100MB é™åˆ¶
              showError("è¯·ä¸Šä¼ å°äº100MBçš„éŸ³é¢‘æ–‡ä»¶");
              return;
            }

            try {
              // ä½¿ç”¨ Web Audio API è§£ç éŸ³é¢‘
              const arrayBuffer = await file.arrayBuffer();
              originalBuffer = await audioContext.decodeAudioData(arrayBuffer);

              // è®¾ç½®æ–‡ä»¶ä¿¡æ¯
              appState.selectedFile = {
                success: true,
                filePath: file.name, // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨æ–‡ä»¶å
                fileName: file.name,
                fileSize: file.size,
              };

              appState.audioInfo = {
                duration: originalBuffer.duration,
                format: file.name.split(".").pop().toLowerCase(),
                sampleRate: originalBuffer.sampleRate,
                channels: originalBuffer.numberOfChannels,
              };

              updateUI();
              hideError();
            } catch (err) {
              console.error("éŸ³é¢‘è§£ç å¤±è´¥:", err);
              showError("éŸ³é¢‘è§£ç å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶");
              appState.selectedFile = null;
              appState.audioInfo = null;
              originalBuffer = null;
            }
          };

          input.click();
        } catch (error) {
          showError("æ–‡ä»¶é€‰æ‹©å¤±è´¥: " + error.message);
        }
      }

      /**
       * å¤„ç†æ‹–æ‹½æ‚¬åœ
       */
      function handleDragOver(event) {
        event.preventDefault();
        elements.fileUploadArea.style.borderColor = "#667eea";
        elements.fileUploadArea.style.background = "#f0f4ff";
      }

      /**
       * å¤„ç†æ–‡ä»¶æ‹–æ‹½æ”¾ç½®
       */
      async function handleDrop(event) {
        event.preventDefault();
        elements.fileUploadArea.style.borderColor = "#ddd";
        elements.fileUploadArea.style.background = "#fafafa";

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const audioExtensions = ["mp3", "wav", "flac", "m4a", "aac", "ogg"];
          const fileExtension = file.name.split(".").pop().toLowerCase();

          if (audioExtensions.includes(fileExtension)) {
            if (file.size > 100 * 1024 * 1024) {
              // 100MB é™åˆ¶
              showError("è¯·ä¸Šä¼ å°äº100MBçš„éŸ³é¢‘æ–‡ä»¶");
              return;
            }

            try {
              // ä½¿ç”¨ Web Audio API è§£ç éŸ³é¢‘
              const arrayBuffer = await file.arrayBuffer();
              originalBuffer = await audioContext.decodeAudioData(arrayBuffer);

              appState.selectedFile = {
                success: true,
                filePath: file.name,
                fileName: file.name,
                fileSize: file.size,
              };

              appState.audioInfo = {
                duration: originalBuffer.duration,
                format: fileExtension,
                sampleRate: originalBuffer.sampleRate,
                channels: originalBuffer.numberOfChannels,
              };

              updateUI();
              hideError();
            } catch (err) {
              console.error("éŸ³é¢‘è§£ç å¤±è´¥:", err);
              showError("éŸ³é¢‘è§£ç å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ–‡ä»¶");
            }
          } else {
            showError("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶");
          }
        }
      }

      /**
       * åˆ‡æ¢éšæœºå»¶é•¿é€‰é¡¹
       */
      function toggleRandomRange() {
        const isChecked = elements.randomExtend.checked;
        elements.randomRangeGroup.style.display = isChecked ? "block" : "none";

        if (isChecked) {
          const range = elements.randomRange.value;
          const rangeHint =
            elements.randomRangeGroup.querySelector(".range-hint");
          rangeHint.textContent = `åœ¨ç›®æ ‡æ—¶é•¿åŸºç¡€ä¸Šéšæœºå¢åŠ  0-${range} ç§’`;
        }
      }

      /**
       * éªŒè¯æ—¶é—´è¾“å…¥æ ¼å¼
       */
      function validateTimeInput() {
        const timeValue = elements.targetTime.value;
        const isValid = window.utils.isValidTimeFormat(timeValue);

        if (timeValue && !isValid) {
          elements.targetTime.style.borderColor = "#dc3545";
        } else {
          elements.targetTime.style.borderColor = "#e9ecef";
        }

        updateUI();
      }

      /**
       * å¤„ç†éŸ³é¢‘æ–‡ä»¶
       */
      async function processAudio() {
        if (appState.isProcessing) return;

        // éªŒè¯è¾“å…¥
        const validation = validateInputs();
        if (!validation.valid) {
          showError(validation.message);
          return;
        }

        try {
          appState.isProcessing = true;
          hideError();
          hideResult();
          showProgress();
          updateUI();

          // è·å–ç›®æ ‡æ—¶é•¿
          const targetSeconds = window.utils.parseTime(
            elements.targetTime.value
          );

          // è®¡ç®—éšæœºå»¶é•¿
          let randomExtra = 0;
          if (elements.randomExtend.checked) {
            const randomRange = parseInt(elements.randomRange.value) || 30;
            randomExtra = Math.floor(Math.random() * (randomRange + 1));
          }

          const totalDuration = targetSeconds + randomExtra;

          updateProgress({ stage: "preparing", progress: 10 });

          // ä½¿ç”¨ Web Audio API å¤„ç†éŸ³é¢‘
          const processedBuffer = await repeatAudioBuffer(
            originalBuffer,
            totalDuration
          );

          updateProgress({ stage: "converting", progress: 80 });

          // è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼
          const outputFormat = elements.outputFormat.value;
          let audioBlob;

          switch (outputFormat) {
            case "wav":
              audioBlob = audioBufferToWAV(processedBuffer);
              break;
            case "m4a":
              audioBlob = audioBufferToM4A(processedBuffer);
              break;
            case "mp3":
              audioBlob = audioBufferToMP3(processedBuffer);
              break;
            case "flac":
              audioBlob = audioBufferToFLAC(processedBuffer);
              break;
            case "aac":
              audioBlob = audioBufferToAAC(processedBuffer);
              break;
            default:
              // é»˜è®¤è¾“å‡ºä¸º WAV
              audioBlob = audioBufferToWAV(processedBuffer);
          }

          updateProgress({ stage: "completed", progress: 100 });

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const url = URL.createObjectURL(audioBlob);
          const defaultName = generateOutputFileName(
            totalDuration,
            outputFormat
          );

          // è§¦å‘ä¸‹è½½
          const a = document.createElement("a");
          a.href = url;
          a.download = defaultName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // æ¸…ç† URL
          setTimeout(() => URL.revokeObjectURL(url), 1000);

          appState.outputPath = defaultName;
          showResult(
            `éŸ³é¢‘æ–‡ä»¶å¤„ç†å®Œæˆï¼æ€»æ—¶é•¿ï¼š${window.utils.formatTime(
              totalDuration
            )}${randomExtra > 0 ? `ï¼ˆå«${randomExtra}ç§’éšæœºå»¶é•¿ï¼‰` : ""}`
          );
        } catch (error) {
          console.error("å¤„ç†å¤±è´¥:", error);
          showError("å¤„ç†å¤±è´¥: " + error.message);
        } finally {
          appState.isProcessing = false;
          hideProgress();
          updateUI();
        }
      }

      /**
       * é‡å¤éŸ³é¢‘ç¼“å†²åŒºåˆ°æŒ‡å®šæ—¶é•¿
       */
      async function repeatAudioBuffer(sourceBuffer, targetDuration) {
        const sampleRate = sourceBuffer.sampleRate;
        const totalSamples = Math.floor(targetDuration * sampleRate);

        // åˆ›å»ºæ–°çš„éŸ³é¢‘ç¼“å†²åŒº
        const newBuffer = audioContext.createBuffer(
          sourceBuffer.numberOfChannels,
          totalSamples,
          sampleRate
        );

        // å¤åˆ¶éŸ³é¢‘æ•°æ®
        for (let channel = 0; channel < newBuffer.numberOfChannels; channel++) {
          const originalData = sourceBuffer.getChannelData(channel);
          const newData = newBuffer.getChannelData(channel);
          let offset = 0;
          const originalLength = originalData.length;

          while (offset < totalSamples) {
            const remaining = totalSamples - offset;
            const copyLength = Math.min(remaining, originalLength);
            newData.set(originalData.subarray(0, copyLength), offset);
            offset += copyLength;

            // æ›´æ–°è¿›åº¦
            const progress = 20 + (offset / totalSamples) * 50; // 20-70%
            updateProgress({ stage: "repeating", progress });

            // è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡ UI
            if (offset % (sampleRate * 5) === 0) {
              // æ¯5ç§’è®©å‡ºä¸€æ¬¡
              await new Promise((resolve) => setTimeout(resolve, 1));
            }
          }
        }

        return newBuffer;
      }

      /**
       * å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸º WAV æ ¼å¼
       */
      function audioBufferToWAV(buffer) {
        const numOfChan = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const format = 1; // PCM
        const bitDepth = 16;
        const dataSize = buffer.length * numOfChan * 2;

        const bufferArray = new ArrayBuffer(44 + dataSize);
        const view = new DataView(bufferArray);

        let pos = 0;

        function writeString(s) {
          for (let i = 0; i < s.length; i++) {
            view.setUint8(pos++, s.charCodeAt(i));
          }
        }

        // RIFF identifier
        writeString("RIFF");
        view.setUint32(pos, 36 + dataSize, true);
        pos += 4;
        writeString("WAVE");

        // fmt subchunk
        writeString("fmt ");
        view.setUint32(pos, 16, true);
        pos += 4;
        view.setUint16(pos, format, true);
        pos += 2;
        view.setUint16(pos, numOfChan, true);
        pos += 2;
        view.setUint32(pos, sampleRate, true);
        pos += 4;
        view.setUint32(pos, sampleRate * numOfChan * (bitDepth / 8), true);
        pos += 4;
        view.setUint16(pos, numOfChan * (bitDepth / 8), true);
        pos += 2;
        view.setUint16(pos, bitDepth, true);
        pos += 2;

        // data subchunk
        writeString("data");
        view.setUint32(pos, dataSize, true);
        pos += 4;

        // å†™å…¥PCMæ•°æ®
        for (let i = 0; i < buffer.length; i++) {
          for (let c = 0; c < numOfChan; c++) {
            const sample = Math.max(
              -1,
              Math.min(1, buffer.getChannelData(c)[i])
            );
            view.setInt16(pos, sample * 0x7fff, true);
            pos += 2;
          }
        }

        return new Blob([view], { type: "audio/wav" });
      }

      /**
       * å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸º M4A æ ¼å¼
       * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå®é™…ä¸Šå°†éŸ³é¢‘æ•°æ®ç¼–ç ä¸º AAC å¹¶å°è£…åœ¨ M4A å®¹å™¨ä¸­
       */
      function audioBufferToM4A(buffer) {
        // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ä»¬æš‚æ—¶ä½¿ç”¨ WAV æ ¼å¼ä½†è®¾ç½®æ­£ç¡®çš„ MIME ç±»å‹
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦ä½¿ç”¨ä¸“é—¨çš„ç¼–ç åº“æ¥ç”ŸæˆçœŸæ­£çš„ M4A æ–‡ä»¶
        const wavData = audioBufferToWAV(buffer);

        // åˆ›å»ºä¸€ä¸ªæ–°çš„ Blobï¼Œä½†ä½¿ç”¨ M4A çš„ MIME ç±»å‹
        // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸ºäº†æ–‡ä»¶æ‰©å±•åæ­£ç¡®ï¼Œå®é™…å†…å®¹ä»æ˜¯ WAV
        return new Blob([wavData], { type: "audio/mp4" });
      }

      /**
       * å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸º MP3 æ ¼å¼
       * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå®é™…å†…å®¹ä¸º WAV æ ¼å¼
       */
      function audioBufferToMP3(buffer) {
        // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ WAV æ ¼å¼ä½†è®¾ç½® MP3 çš„ MIME ç±»å‹
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/mpeg" });
      }

      /**
       * å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸º FLAC æ ¼å¼
       * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå®é™…å†…å®¹ä¸º WAV æ ¼å¼
       */
      function audioBufferToFLAC(buffer) {
        // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ WAV æ ¼å¼ä½†è®¾ç½® FLAC çš„ MIME ç±»å‹
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/flac" });
      }

      /**
       * å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸º AAC æ ¼å¼
       * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å®ç°ï¼Œå®é™…å†…å®¹ä¸º WAV æ ¼å¼
       */
      function audioBufferToAAC(buffer) {
        // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ WAV æ ¼å¼ä½†è®¾ç½® AAC çš„ MIME ç±»å‹
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/aac" });
      }

      /**
       * éªŒè¯ç”¨æˆ·è¾“å…¥
       */
      function validateInputs() {
        if (!appState.selectedFile || !originalBuffer) {
          return { valid: false, message: "è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶" };
        }

        const timeValue = elements.targetTime.value.trim();
        if (!timeValue) {
          return { valid: false, message: "è¯·è¾“å…¥ç›®æ ‡æ—¶é•¿" };
        }

        if (!window.utils.isValidTimeFormat(timeValue)) {
          return {
            valid: false,
            message: "æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ MM:SS æˆ– HH:MM:SS æ ¼å¼",
          };
        }

        const targetSeconds = window.utils.parseTime(timeValue);
        if (targetSeconds <= 0) {
          return { valid: false, message: "ç›®æ ‡æ—¶é•¿å¿…é¡»å¤§äº 0" };
        }

        if (targetSeconds > 86400) {
          // 24å°æ—¶
          return { valid: false, message: "ç›®æ ‡æ—¶é•¿ä¸èƒ½è¶…è¿‡ 24 å°æ—¶" };
        }

        return { valid: true };
      }

      /**
       * ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
       */
      function generateOutputFileName(targetSeconds, format = "wav") {
        const originalName = appState.selectedFile.fileName;
        const nameWithoutExt = originalName.substring(
          0,
          originalName.lastIndexOf(".")
        );
        const timeStr = window.utils.formatTime(targetSeconds);

        return `${nameWithoutExt}_${timeStr.replace(/:/g, "-")}.${format}`;
      }

      /**
       * æ›´æ–°å¤„ç†è¿›åº¦
       */
      function updateProgress(progress) {
        const stageTexts = {
          calculating: "è®¡ç®—ä¸­...",
          preparing: "å‡†å¤‡å¤„ç†...",
          repeating: "é‡å¤éŸ³é¢‘...",
          processing: "å¤„ç†ä¸­...",
          converting: "è½¬æ¢æ ¼å¼...",
          completed: "å®Œæˆ",
        };

        elements.progressStage.textContent =
          stageTexts[progress.stage] || "å¤„ç†ä¸­...";
        elements.progressPercent.textContent =
          Math.round(progress.progress) + "%";
        elements.progressFill.style.width = progress.progress + "%";
      }

      /**
       * æ˜¾ç¤ºå¤„ç†è¿›åº¦
       */
      function showProgress() {
        elements.progressContainer.style.display = "block";
        elements.progressFill.style.width = "0%";
        elements.progressStage.textContent = "å‡†å¤‡ä¸­...";
        elements.progressPercent.textContent = "0%";
      }

      /**
       * éšè—å¤„ç†è¿›åº¦
       */
      function hideProgress() {
        elements.progressContainer.style.display = "none";
      }

      /**
       * æ˜¾ç¤ºå¤„ç†ç»“æœ
       */
      function showResult(message) {
        elements.resultMessage.textContent = message;
        elements.resultContainer.style.display = "block";
      }

      /**
       * éšè—å¤„ç†ç»“æœ
       */
      function hideResult() {
        elements.resultContainer.style.display = "none";
      }

      /**
       * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
       */
      function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorContainer.style.display = "block";
      }

      /**
       * éšè—é”™è¯¯ä¿¡æ¯
       */
      function hideError() {
        elements.errorContainer.style.display = "none";
      }

      /**
       * æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä¸é€‚ç”¨ï¼‰
       */
      async function openOutputFolder() {
        showError("æµè§ˆå™¨ç¯å¢ƒä¸­æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½ç›®å½•");
      }

      /**
       * é‡ç½®åº”ç”¨çŠ¶æ€
       */
      function resetApp() {
        appState.selectedFile = null;
        appState.audioInfo = null;
        appState.outputPath = null;
        originalBuffer = null;

        hideResult();
        hideError();
        hideProgress();

        // é‡ç½®è¡¨å•
        elements.targetTime.value = "10:00";
        elements.randomExtend.checked = true; // é»˜è®¤å¯ç”¨éšæœºå»¶é•¿
        elements.randomRange.value = "30";
        elements.outputFormat.value = "m4a"; // é»˜è®¤ä½¿ç”¨ M4A æ ¼å¼

        toggleRandomRange();
        updateUI();
      }

      /**
       * æ›´æ–°ç”¨æˆ·ç•Œé¢
       */
      function updateUI() {
        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        if (appState.selectedFile && appState.audioInfo) {
          elements.fileUploadArea.style.display = "none";
          elements.fileInfo.style.display = "flex";

          elements.fileName.textContent = appState.selectedFile.fileName;
          elements.fileSize.textContent = window.utils.formatFileSize(
            appState.selectedFile.fileSize
          );
          elements.fileDuration.textContent = window.utils.formatTime(
            appState.audioInfo.duration
          );
          elements.fileFormat.textContent =
            appState.audioInfo.format.toUpperCase();
        } else {
          elements.fileUploadArea.style.display = "block";
          elements.fileInfo.style.display = "none";
        }

        // æ›´æ–°å¤„ç†æŒ‰é’®çŠ¶æ€
        const canProcess =
          appState.selectedFile &&
          appState.audioInfo &&
          !appState.isProcessing &&
          elements.targetTime.value.trim() &&
          window.utils.isValidTimeFormat(elements.targetTime.value);

        elements.processBtn.disabled = !canProcess;

        if (appState.isProcessing) {
          elements.processBtn.querySelector(".btn-text").textContent =
            "å¤„ç†ä¸­...";
          elements.processBtn.querySelector(".btn-icon").textContent = "â³";
        } else {
          elements.processBtn.querySelector(".btn-text").textContent =
            "å¼€å§‹å¤„ç†";
          elements.processBtn.querySelector(".btn-icon").textContent = "ğŸš€";
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
      document.addEventListener("DOMContentLoaded", initApp);

      // ç›‘å¬éšæœºèŒƒå›´è¾“å…¥å˜åŒ–
      document
        .getElementById("randomRange")
        .addEventListener("input", function () {
          if (elements.randomExtend.checked) {
            const range = this.value;
            const rangeHint =
              elements.randomRangeGroup.querySelector(".range-hint");
            rangeHint.textContent = `åœ¨ç›®æ ‡æ—¶é•¿åŸºç¡€ä¸Šéšæœºå¢åŠ  0-${range} ç§’`;
          }
        });

      // å¼¹çª—å‡½æ•°
      function showDiffModal() {
        elements.diffModalOverlay.style.display = "flex";
      }

      function hideDiffModal() {
        elements.diffModalOverlay.style.display = "none";
      }
    </script>
  </body>
</html>
