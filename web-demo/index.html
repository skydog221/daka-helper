<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>打卡剪辑助手 - Demo</title>
    <style>
      /* 全局样式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* 标题栏样式 */
      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
      }

      /* 主要内容区域 */
      .main-content {
        flex: 1;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      /* 文件选择区域 */
      .file-section {
        margin-bottom: 30px;
      }

      .file-upload-area {
        border: 3px dashed #ddd;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafafa;
      }

      .file-upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .upload-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .upload-hint {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      .select-file-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .select-file-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      /* 文件信息显示 */
      .file-info {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid #e9ecef;
      }

      .file-details h3 {
        color: #333;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }

      .file-meta {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #666;
      }

      .file-meta span {
        background: white;
        padding: 4px 12px;
        border-radius: 20px;
        border: 1px solid #ddd;
      }

      .change-file-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .change-file-btn:hover {
        background: #5a6268;
      }

      /* 设置区域 */
      .settings-section {
        margin-bottom: 30px;
      }

      .settings-section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .setting-group {
        margin-bottom: 20px;
      }

      .setting-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .time-input-group {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .time-input-group input {
        flex: 0 0 150px;
      }

      .time-hint,
      .range-hint {
        color: #666;
        font-size: 0.85rem;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        transform: scale(1.2);
      }

      .checkbox-group label {
        margin-bottom: 0;
        cursor: pointer;
      }

      .random-range-group {
        margin-left: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      /* 处理按钮和进度 */
      .process-section {
        text-align: center;
      }

      .process-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 auto 20px;
      }

      .process-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
      }

      .process-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-icon {
        font-size: 1.2rem;
      }

      /* 进度显示 */
      .progress-container {
        max-width: 400px;
        margin: 0 auto 20px;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 600;
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
      }

      /* 结果显示 */
      .result-container,
      .error-container {
        max-width: 400px;
        margin: 0 auto;
      }

      .result-success,
      .error-message {
        background: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .success-icon,
      .error-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .result-success h3,
      .error-message h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.3rem;
      }

      .result-success p,
      .error-message p {
        color: #666;
        margin-bottom: 20px;
      }

      .result-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .result-btn,
      .error-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .result-btn.secondary {
        background: #6c757d;
      }

      .result-btn:hover,
      .error-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      /* 底部信息 */
      .footer {
        text-align: center;
        color: white;
        opacity: 0.8;
        font-size: 0.9rem;
      }

      .footer-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
      }

      .github-btn {
        background: #333;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .github-btn:hover {
        background: #555;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .diff-btn {
        background: #007bff; /* 蓝色 */
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .diff-btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .main-content {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .file-upload-area {
          padding: 30px 15px;
        }

        .file-info {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .file-meta {
          justify-content: center;
          flex-wrap: wrap;
        }

        .time-input-group {
          flex-direction: column;
          align-items: flex-start;
        }

        .result-actions {
          flex-direction: column;
        }
      }

      /* 动画效果 */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-info,
      .progress-container,
      .result-container,
      .error-container {
        animation: fadeIn 0.5s ease;
      }

      /* 弹窗样式 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        text-align: left;
        position: relative;
        animation: slideIn 0.3s ease-out;
      }

      .modal-content h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.4rem;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .modal-content ul {
        list-style: disc;
        margin-left: 20px;
        margin-bottom: 20px;
        color: #555;
      }

      .modal-content ul li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      .modal-close-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        display: block;
        margin: 0 auto;
      }

      .modal-close-btn:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* 滚动条样式 */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 标题栏 -->
      <header class="header">
        <h1>🎵 打卡剪辑助手</h1>
        <p class="subtitle">快速重复拼接音频到指定时间</p>
      </header>

      <!-- 主要内容区域 -->
      <main class="main-content">
        <!-- 文件选择区域 -->
        <section class="file-section">
          <div class="file-upload-area" id="fileUploadArea">
            <div class="upload-icon">📁</div>
            <p class="upload-text">点击选择音频文件</p>
            <p class="upload-hint">支持 MP3、WAV、FLAC、M4A、AAC、OGG 格式</p>
            <button class="select-file-btn" id="selectFileBtn">选择文件</button>
          </div>

          <!-- 文件信息显示 -->
          <div class="file-info" id="fileInfo" style="display: none">
            <div class="file-details">
              <h3 id="fileName">文件名</h3>
              <div class="file-meta">
                <span id="fileSize">文件大小</span>
                <span id="fileDuration">时长</span>
                <span id="fileFormat">格式</span>
              </div>
            </div>
            <button class="change-file-btn" id="changeFileBtn">更换文件</button>
          </div>
        </section>

        <!-- 设置区域 -->
        <section class="settings-section">
          <h2>处理设置</h2>

          <!-- 目标时间设置 -->
          <div class="setting-group">
            <label for="targetTime">目标时长</label>
            <div class="time-input-group">
              <input
                type="text"
                id="targetTime"
                placeholder="MM:SS 或 HH:MM:SS"
                value="10:00"
              />
              <span class="time-hint">格式：分:秒 或 时:分:秒</span>
            </div>
          </div>

          <!-- 随机延长设置 -->
          <div class="setting-group">
            <div class="checkbox-group">
              <input type="checkbox" id="randomExtend" checked />
              <label for="randomExtend">随机延长</label>
            </div>
            <div
              class="random-range-group"
              id="randomRangeGroup"
              style="display: block"
            >
              <label for="randomRange">延长范围（秒）</label>
              <input
                type="number"
                id="randomRange"
                min="1"
                max="300"
                value="30"
              />
              <span class="range-hint">在目标时长基础上随机增加 0-30 秒</span>
            </div>
          </div>

          <!-- 输出格式设置 -->
          <div class="setting-group">
            <label for="outputFormat">输出格式</label>
            <select id="outputFormat">
              <option value="m4a">M4A (推荐)</option>
              <option value="wav">WAV (无损)</option>
              <option value="mp3">MP3</option>
              <option value="flac">FLAC (无损压缩)</option>
              <option value="aac">AAC</option>
            </select>
          </div>
        </section>

        <!-- 处理按钮和进度 -->
        <section class="process-section">
          <button class="process-btn" id="processBtn" disabled>
            <span class="btn-icon">🚀</span>
            <span class="btn-text">开始处理</span>
          </button>

          <!-- 进度显示 -->
          <div
            class="progress-container"
            id="progressContainer"
            style="display: none"
          >
            <div class="progress-info">
              <span id="progressStage">准备中...</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <!-- 结果显示 -->
          <div
            class="result-container"
            id="resultContainer"
            style="display: none"
          >
            <div class="result-success">
              <div class="success-icon">✅</div>
              <h3>处理完成！</h3>
              <p id="resultMessage">音频文件已成功处理</p>
              <div class="result-actions">
                <button class="result-btn" id="openFolderBtn">
                  打开文件夹
                </button>
                <button class="result-btn secondary" id="processAnotherBtn">
                  处理其他文件
                </button>
              </div>
            </div>
          </div>

          <!-- 错误显示 -->
          <div
            class="error-container"
            id="errorContainer"
            style="display: none"
          >
            <div class="error-message">
              <div class="error-icon">❌</div>
              <h3>处理失败</h3>
              <p id="errorMessage">发生了未知错误</p>
              <button class="error-btn" id="retryBtn">重试</button>
            </div>
          </div>
        </section>
      </main>

      <!-- 区别弹窗 -->
      <div class="modal-overlay" id="diffModalOverlay" style="display: none">
        <div class="modal-content">
          <h3>桌面版与网页Demo的区别</h3>
          <p>此 Demo 版本是纯前端实现，主要区别在于：</p>
          <ul>
            <li>
              文件操作：
              无法直接访问本地文件系统，文件选择和保存通过浏览器内置的文件 API
              实现（文件将自动下载到您的默认下载目录）。
            </li>
            <li>
              音频编码： 浏览器环境下的音频编码能力有限，目前除 WAV
              外，其他格式（M4A, MP3, FLAC, AAC）的输出文件实际内容仍为
              WAV，仅修改了文件扩展名和 MIME 类型。Electron 版本可以利用 FFmpeg
              进行更专业的编码。
            </li>
            <li>系统集成： 无法实现如“打开输出文件夹”等系统级操作。</li>
          </ul>
          <button class="modal-close-btn" id="closeDiffModalBtn">关闭</button>
        </div>
      </div>

      <!-- 底部信息 -->
      <footer class="footer">
        <p>© 2025 打卡剪辑助手 - 让音频处理更简单</p>
        <div class="footer-actions">
          <button class="github-btn" id="githubRepoBtn">
            前往 GitHub 仓库
          </button>
          <button class="diff-btn" id="showDiffBtn">
            桌面版与网页Demo的区别
          </button>
        </div>
      </footer>
    </div>

    <script>
      // window.utils content from preload.js
      const utils = {
        /**
         * 格式化文件大小
         * @param {number} bytes - 字节数
         * @returns {string} 格式化的文件大小
         */
        formatFileSize: (bytes) => {
          if (bytes === 0) return "0 Bytes";

          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));

          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        },

        /**
         * 格式化时间显示
         * @param {number} seconds - 秒数
         * @returns {string} 格式化的时间字符串
         */
        formatTime: (seconds) => {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = Math.floor(seconds % 60);

          if (hours > 0) {
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          } else {
            return `${minutes.toString().padStart(2, "0")}:${secs
              .toString()
              .padStart(2, "0")}`;
          }
        },

        /**
         * 解析时间字符串为秒数
         * @param {string} timeString - 时间字符串 (HH:MM:SS 或 MM:SS)
         * @returns {number} 秒数
         */
        parseTime: (timeString) => {
          const parts = timeString.split(":").map((part) => parseInt(part, 10));

          if (parts.length === 3) {
            // HH:MM:SS
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
          } else if (parts.length === 2) {
            // MM:SS
            return parts[0] * 60 + parts[1];
          } else if (parts.length === 1) {
            // SS
            return parts[0];
          }

          return 0;
        },

        /**
         * 验证时间格式
         * @param {string} timeString - 时间字符串
         * @returns {boolean} 是否有效
         */
        isValidTimeFormat: (timeString) => {
          const timeRegex = /^(\d{1,2}:)?(\d{1,2}):(\d{1,2})$/;
          return timeRegex.test(timeString);
        },
      };

      // 在浏览器环境中直接将 utils 挂载到 window 对象
      window.utils = utils;
    </script>
    <script>
      /**
       * 渲染进程主要 JavaScript 文件
       * 处理用户界面交互和音频处理（使用 Web Audio API）
       */

      // 音频上下文和状态
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
      let originalBuffer = null;

      // 应用状态
      let appState = {
        selectedFile: null,
        audioInfo: null,
        isProcessing: false,
        outputPath: null,
      };

      // DOM 元素引用
      const elements = {
        fileUploadArea: document.getElementById("fileUploadArea"),
        selectFileBtn: document.getElementById("selectFileBtn"),
        fileInfo: document.getElementById("fileInfo"),
        fileName: document.getElementById("fileName"),
        fileSize: document.getElementById("fileSize"),
        fileDuration: document.getElementById("fileDuration"),
        fileFormat: document.getElementById("fileFormat"),
        changeFileBtn: document.getElementById("changeFileBtn"),

        targetTime: document.getElementById("targetTime"),
        randomExtend: document.getElementById("randomExtend"),
        randomRangeGroup: document.getElementById("randomRangeGroup"),
        randomRange: document.getElementById("randomRange"),
        outputFormat: document.getElementById("outputFormat"),

        processBtn: document.getElementById("processBtn"),
        progressContainer: document.getElementById("progressContainer"),
        progressStage: document.getElementById("progressStage"),
        progressPercent: document.getElementById("progressPercent"),
        progressFill: document.getElementById("progressFill"),

        resultContainer: document.getElementById("resultContainer"),
        resultMessage: document.getElementById("resultMessage"),
        openFolderBtn: document.getElementById("openFolderBtn"),
        processAnotherBtn: document.getElementById("processAnotherBtn"),

        errorContainer: document.getElementById("errorContainer"),
        errorMessage: document.getElementById("errorMessage"),
        retryBtn: document.getElementById("retryBtn"),

        // 新增的 DOM 引用
        githubRepoBtn: document.getElementById("githubRepoBtn"),
        diffModalOverlay: document.getElementById("diffModalOverlay"),
        showDiffBtn: document.getElementById("showDiffBtn"),
        closeDiffModalBtn: document.getElementById("closeDiffModalBtn"),
      };

      /**
       * 初始化应用
       */
      function initApp() {
        setupEventListeners();
        updateUI();
      }

      /**
       * 设置事件监听器
       */
      function setupEventListeners() {
        // 文件选择相关
        elements.selectFileBtn.addEventListener("click", selectFile);
        elements.changeFileBtn.addEventListener("click", selectFile);
        // 移除上传区域的点击事件，避免与按钮点击重复触发
        // elements.fileUploadArea.addEventListener("click", selectFile);

        // 拖拽上传支持
        elements.fileUploadArea.addEventListener("dragover", handleDragOver);
        elements.fileUploadArea.addEventListener("drop", handleDrop);

        // 设置相关
        elements.randomExtend.addEventListener("change", toggleRandomRange);
        elements.targetTime.addEventListener("input", validateTimeInput);

        // 处理按钮
        elements.processBtn.addEventListener("click", processAudio);

        // 结果操作
        elements.openFolderBtn.addEventListener("click", openOutputFolder);
        elements.processAnotherBtn.addEventListener("click", resetApp);
        elements.retryBtn.addEventListener("click", processAudio);

        // 新增的事件监听
        elements.githubRepoBtn.addEventListener("click", () => {
          window.open("https://github.com/skydog221/daka-helper", "_blank");
        });

        elements.showDiffBtn.addEventListener("click", showDiffModal);
        elements.closeDiffModalBtn.addEventListener("click", hideDiffModal);
        elements.diffModalOverlay.addEventListener("click", (e) => {
          if (e.target === elements.diffModalOverlay) {
            hideDiffModal();
          }
        });
      }

      /**
       * 选择音频文件
       */
      async function selectFile() {
        try {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "audio/*";

          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 100 * 1024 * 1024) {
              // 100MB 限制
              showError("请上传小于100MB的音频文件");
              return;
            }

            try {
              // 使用 Web Audio API 解码音频
              const arrayBuffer = await file.arrayBuffer();
              originalBuffer = await audioContext.decodeAudioData(arrayBuffer);

              // 设置文件信息
              appState.selectedFile = {
                success: true,
                filePath: file.name, // 在浏览器环境中使用文件名
                fileName: file.name,
                fileSize: file.size,
              };

              appState.audioInfo = {
                duration: originalBuffer.duration,
                format: file.name.split(".").pop().toLowerCase(),
                sampleRate: originalBuffer.sampleRate,
                channels: originalBuffer.numberOfChannels,
              };

              updateUI();
              hideError();
            } catch (err) {
              console.error("音频解码失败:", err);
              showError("音频解码失败，请尝试其他文件");
              appState.selectedFile = null;
              appState.audioInfo = null;
              originalBuffer = null;
            }
          };

          input.click();
        } catch (error) {
          showError("文件选择失败: " + error.message);
        }
      }

      /**
       * 处理拖拽悬停
       */
      function handleDragOver(event) {
        event.preventDefault();
        elements.fileUploadArea.style.borderColor = "#667eea";
        elements.fileUploadArea.style.background = "#f0f4ff";
      }

      /**
       * 处理文件拖拽放置
       */
      async function handleDrop(event) {
        event.preventDefault();
        elements.fileUploadArea.style.borderColor = "#ddd";
        elements.fileUploadArea.style.background = "#fafafa";

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const audioExtensions = ["mp3", "wav", "flac", "m4a", "aac", "ogg"];
          const fileExtension = file.name.split(".").pop().toLowerCase();

          if (audioExtensions.includes(fileExtension)) {
            if (file.size > 100 * 1024 * 1024) {
              // 100MB 限制
              showError("请上传小于100MB的音频文件");
              return;
            }

            try {
              // 使用 Web Audio API 解码音频
              const arrayBuffer = await file.arrayBuffer();
              originalBuffer = await audioContext.decodeAudioData(arrayBuffer);

              appState.selectedFile = {
                success: true,
                filePath: file.name,
                fileName: file.name,
                fileSize: file.size,
              };

              appState.audioInfo = {
                duration: originalBuffer.duration,
                format: fileExtension,
                sampleRate: originalBuffer.sampleRate,
                channels: originalBuffer.numberOfChannels,
              };

              updateUI();
              hideError();
            } catch (err) {
              console.error("音频解码失败:", err);
              showError("音频解码失败，请尝试其他文件");
            }
          } else {
            showError("不支持的文件格式，请选择音频文件");
          }
        }
      }

      /**
       * 切换随机延长选项
       */
      function toggleRandomRange() {
        const isChecked = elements.randomExtend.checked;
        elements.randomRangeGroup.style.display = isChecked ? "block" : "none";

        if (isChecked) {
          const range = elements.randomRange.value;
          const rangeHint =
            elements.randomRangeGroup.querySelector(".range-hint");
          rangeHint.textContent = `在目标时长基础上随机增加 0-${range} 秒`;
        }
      }

      /**
       * 验证时间输入格式
       */
      function validateTimeInput() {
        const timeValue = elements.targetTime.value;
        const isValid = window.utils.isValidTimeFormat(timeValue);

        if (timeValue && !isValid) {
          elements.targetTime.style.borderColor = "#dc3545";
        } else {
          elements.targetTime.style.borderColor = "#e9ecef";
        }

        updateUI();
      }

      /**
       * 处理音频文件
       */
      async function processAudio() {
        if (appState.isProcessing) return;

        // 验证输入
        const validation = validateInputs();
        if (!validation.valid) {
          showError(validation.message);
          return;
        }

        try {
          appState.isProcessing = true;
          hideError();
          hideResult();
          showProgress();
          updateUI();

          // 获取目标时长
          const targetSeconds = window.utils.parseTime(
            elements.targetTime.value
          );

          // 计算随机延长
          let randomExtra = 0;
          if (elements.randomExtend.checked) {
            const randomRange = parseInt(elements.randomRange.value) || 30;
            randomExtra = Math.floor(Math.random() * (randomRange + 1));
          }

          const totalDuration = targetSeconds + randomExtra;

          updateProgress({ stage: "preparing", progress: 10 });

          // 使用 Web Audio API 处理音频
          const processedBuffer = await repeatAudioBuffer(
            originalBuffer,
            totalDuration
          );

          updateProgress({ stage: "converting", progress: 80 });

          // 转换为指定格式
          const outputFormat = elements.outputFormat.value;
          let audioBlob;

          switch (outputFormat) {
            case "wav":
              audioBlob = audioBufferToWAV(processedBuffer);
              break;
            case "m4a":
              audioBlob = audioBufferToM4A(processedBuffer);
              break;
            case "mp3":
              audioBlob = audioBufferToMP3(processedBuffer);
              break;
            case "flac":
              audioBlob = audioBufferToFLAC(processedBuffer);
              break;
            case "aac":
              audioBlob = audioBufferToAAC(processedBuffer);
              break;
            default:
              // 默认输出为 WAV
              audioBlob = audioBufferToWAV(processedBuffer);
          }

          updateProgress({ stage: "completed", progress: 100 });

          // 创建下载链接
          const url = URL.createObjectURL(audioBlob);
          const defaultName = generateOutputFileName(
            totalDuration,
            outputFormat
          );

          // 触发下载
          const a = document.createElement("a");
          a.href = url;
          a.download = defaultName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          // 清理 URL
          setTimeout(() => URL.revokeObjectURL(url), 1000);

          appState.outputPath = defaultName;
          showResult(
            `音频文件处理完成！总时长：${window.utils.formatTime(
              totalDuration
            )}${randomExtra > 0 ? `（含${randomExtra}秒随机延长）` : ""}`
          );
        } catch (error) {
          console.error("处理失败:", error);
          showError("处理失败: " + error.message);
        } finally {
          appState.isProcessing = false;
          hideProgress();
          updateUI();
        }
      }

      /**
       * 重复音频缓冲区到指定时长
       */
      async function repeatAudioBuffer(sourceBuffer, targetDuration) {
        const sampleRate = sourceBuffer.sampleRate;
        const totalSamples = Math.floor(targetDuration * sampleRate);

        // 创建新的音频缓冲区
        const newBuffer = audioContext.createBuffer(
          sourceBuffer.numberOfChannels,
          totalSamples,
          sampleRate
        );

        // 复制音频数据
        for (let channel = 0; channel < newBuffer.numberOfChannels; channel++) {
          const originalData = sourceBuffer.getChannelData(channel);
          const newData = newBuffer.getChannelData(channel);
          let offset = 0;
          const originalLength = originalData.length;

          while (offset < totalSamples) {
            const remaining = totalSamples - offset;
            const copyLength = Math.min(remaining, originalLength);
            newData.set(originalData.subarray(0, copyLength), offset);
            offset += copyLength;

            // 更新进度
            const progress = 20 + (offset / totalSamples) * 50; // 20-70%
            updateProgress({ stage: "repeating", progress });

            // 让出控制权，避免阻塞 UI
            if (offset % (sampleRate * 5) === 0) {
              // 每5秒让出一次
              await new Promise((resolve) => setTimeout(resolve, 1));
            }
          }
        }

        return newBuffer;
      }

      /**
       * 将音频缓冲区转换为 WAV 格式
       */
      function audioBufferToWAV(buffer) {
        const numOfChan = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const format = 1; // PCM
        const bitDepth = 16;
        const dataSize = buffer.length * numOfChan * 2;

        const bufferArray = new ArrayBuffer(44 + dataSize);
        const view = new DataView(bufferArray);

        let pos = 0;

        function writeString(s) {
          for (let i = 0; i < s.length; i++) {
            view.setUint8(pos++, s.charCodeAt(i));
          }
        }

        // RIFF identifier
        writeString("RIFF");
        view.setUint32(pos, 36 + dataSize, true);
        pos += 4;
        writeString("WAVE");

        // fmt subchunk
        writeString("fmt ");
        view.setUint32(pos, 16, true);
        pos += 4;
        view.setUint16(pos, format, true);
        pos += 2;
        view.setUint16(pos, numOfChan, true);
        pos += 2;
        view.setUint32(pos, sampleRate, true);
        pos += 4;
        view.setUint32(pos, sampleRate * numOfChan * (bitDepth / 8), true);
        pos += 4;
        view.setUint16(pos, numOfChan * (bitDepth / 8), true);
        pos += 2;
        view.setUint16(pos, bitDepth, true);
        pos += 2;

        // data subchunk
        writeString("data");
        view.setUint32(pos, dataSize, true);
        pos += 4;

        // 写入PCM数据
        for (let i = 0; i < buffer.length; i++) {
          for (let c = 0; c < numOfChan; c++) {
            const sample = Math.max(
              -1,
              Math.min(1, buffer.getChannelData(c)[i])
            );
            view.setInt16(pos, sample * 0x7fff, true);
            pos += 2;
          }
        }

        return new Blob([view], { type: "audio/wav" });
      }

      /**
       * 将音频缓冲区转换为 M4A 格式
       * 注意：这是一个简化的实现，实际上将音频数据编码为 AAC 并封装在 M4A 容器中
       */
      function audioBufferToM4A(buffer) {
        // 由于浏览器环境限制，我们暂时使用 WAV 格式但设置正确的 MIME 类型
        // 在实际应用中，需要使用专门的编码库来生成真正的 M4A 文件
        const wavData = audioBufferToWAV(buffer);

        // 创建一个新的 Blob，但使用 M4A 的 MIME 类型
        // 注意：这只是为了文件扩展名正确，实际内容仍是 WAV
        return new Blob([wavData], { type: "audio/mp4" });
      }

      /**
       * 将音频缓冲区转换为 MP3 格式
       * 注意：这是一个简化的实现，实际内容为 WAV 格式
       */
      function audioBufferToMP3(buffer) {
        // 由于浏览器环境限制，我们使用 WAV 格式但设置 MP3 的 MIME 类型
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/mpeg" });
      }

      /**
       * 将音频缓冲区转换为 FLAC 格式
       * 注意：这是一个简化的实现，实际内容为 WAV 格式
       */
      function audioBufferToFLAC(buffer) {
        // 由于浏览器环境限制，我们使用 WAV 格式但设置 FLAC 的 MIME 类型
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/flac" });
      }

      /**
       * 将音频缓冲区转换为 AAC 格式
       * 注意：这是一个简化的实现，实际内容为 WAV 格式
       */
      function audioBufferToAAC(buffer) {
        // 由于浏览器环境限制，我们使用 WAV 格式但设置 AAC 的 MIME 类型
        const wavData = audioBufferToWAV(buffer);
        return new Blob([wavData], { type: "audio/aac" });
      }

      /**
       * 验证用户输入
       */
      function validateInputs() {
        if (!appState.selectedFile || !originalBuffer) {
          return { valid: false, message: "请先选择音频文件" };
        }

        const timeValue = elements.targetTime.value.trim();
        if (!timeValue) {
          return { valid: false, message: "请输入目标时长" };
        }

        if (!window.utils.isValidTimeFormat(timeValue)) {
          return {
            valid: false,
            message: "时间格式不正确，请使用 MM:SS 或 HH:MM:SS 格式",
          };
        }

        const targetSeconds = window.utils.parseTime(timeValue);
        if (targetSeconds <= 0) {
          return { valid: false, message: "目标时长必须大于 0" };
        }

        if (targetSeconds > 86400) {
          // 24小时
          return { valid: false, message: "目标时长不能超过 24 小时" };
        }

        return { valid: true };
      }

      /**
       * 生成输出文件名
       */
      function generateOutputFileName(targetSeconds, format = "wav") {
        const originalName = appState.selectedFile.fileName;
        const nameWithoutExt = originalName.substring(
          0,
          originalName.lastIndexOf(".")
        );
        const timeStr = window.utils.formatTime(targetSeconds);

        return `${nameWithoutExt}_${timeStr.replace(/:/g, "-")}.${format}`;
      }

      /**
       * 更新处理进度
       */
      function updateProgress(progress) {
        const stageTexts = {
          calculating: "计算中...",
          preparing: "准备处理...",
          repeating: "重复音频...",
          processing: "处理中...",
          converting: "转换格式...",
          completed: "完成",
        };

        elements.progressStage.textContent =
          stageTexts[progress.stage] || "处理中...";
        elements.progressPercent.textContent =
          Math.round(progress.progress) + "%";
        elements.progressFill.style.width = progress.progress + "%";
      }

      /**
       * 显示处理进度
       */
      function showProgress() {
        elements.progressContainer.style.display = "block";
        elements.progressFill.style.width = "0%";
        elements.progressStage.textContent = "准备中...";
        elements.progressPercent.textContent = "0%";
      }

      /**
       * 隐藏处理进度
       */
      function hideProgress() {
        elements.progressContainer.style.display = "none";
      }

      /**
       * 显示处理结果
       */
      function showResult(message) {
        elements.resultMessage.textContent = message;
        elements.resultContainer.style.display = "block";
      }

      /**
       * 隐藏处理结果
       */
      function hideResult() {
        elements.resultContainer.style.display = "none";
      }

      /**
       * 显示错误信息
       */
      function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorContainer.style.display = "block";
      }

      /**
       * 隐藏错误信息
       */
      function hideError() {
        elements.errorContainer.style.display = "none";
      }

      /**
       * 打开输出文件夹（在浏览器环境中不适用）
       */
      async function openOutputFolder() {
        showError("浏览器环境中无法打开文件夹，文件已自动下载到默认下载目录");
      }

      /**
       * 重置应用状态
       */
      function resetApp() {
        appState.selectedFile = null;
        appState.audioInfo = null;
        appState.outputPath = null;
        originalBuffer = null;

        hideResult();
        hideError();
        hideProgress();

        // 重置表单
        elements.targetTime.value = "10:00";
        elements.randomExtend.checked = true; // 默认启用随机延长
        elements.randomRange.value = "30";
        elements.outputFormat.value = "m4a"; // 默认使用 M4A 格式

        toggleRandomRange();
        updateUI();
      }

      /**
       * 更新用户界面
       */
      function updateUI() {
        // 更新文件信息显示
        if (appState.selectedFile && appState.audioInfo) {
          elements.fileUploadArea.style.display = "none";
          elements.fileInfo.style.display = "flex";

          elements.fileName.textContent = appState.selectedFile.fileName;
          elements.fileSize.textContent = window.utils.formatFileSize(
            appState.selectedFile.fileSize
          );
          elements.fileDuration.textContent = window.utils.formatTime(
            appState.audioInfo.duration
          );
          elements.fileFormat.textContent =
            appState.audioInfo.format.toUpperCase();
        } else {
          elements.fileUploadArea.style.display = "block";
          elements.fileInfo.style.display = "none";
        }

        // 更新处理按钮状态
        const canProcess =
          appState.selectedFile &&
          appState.audioInfo &&
          !appState.isProcessing &&
          elements.targetTime.value.trim() &&
          window.utils.isValidTimeFormat(elements.targetTime.value);

        elements.processBtn.disabled = !canProcess;

        if (appState.isProcessing) {
          elements.processBtn.querySelector(".btn-text").textContent =
            "处理中...";
          elements.processBtn.querySelector(".btn-icon").textContent = "⏳";
        } else {
          elements.processBtn.querySelector(".btn-text").textContent =
            "开始处理";
          elements.processBtn.querySelector(".btn-icon").textContent = "🚀";
        }
      }

      // 页面加载完成后初始化应用
      document.addEventListener("DOMContentLoaded", initApp);

      // 监听随机范围输入变化
      document
        .getElementById("randomRange")
        .addEventListener("input", function () {
          if (elements.randomExtend.checked) {
            const range = this.value;
            const rangeHint =
              elements.randomRangeGroup.querySelector(".range-hint");
            rangeHint.textContent = `在目标时长基础上随机增加 0-${range} 秒`;
          }
        });

      // 弹窗函数
      function showDiffModal() {
        elements.diffModalOverlay.style.display = "flex";
      }

      function hideDiffModal() {
        elements.diffModalOverlay.style.display = "none";
      }
    </script>
  </body>
</html>
