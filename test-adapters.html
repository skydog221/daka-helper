<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹³å°é€‚é…å™¨æµ‹è¯• - Daka Helper</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .test-section h2 {
      color: #4CAF50;
      margin-top: 0;
    }
    
    .test-case {
      margin: 15px 0;
      padding: 10px;
      border-left: 3px solid #ddd;
      background: #f9f9f9;
    }
    
    .test-case.pass {
      border-left-color: #4CAF50;
      background: #f1f8f4;
    }
    
    .test-case.fail {
      border-left-color: #f44336;
      background: #fff5f5;
    }
    
    .test-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .test-result {
      font-size: 0.9em;
      color: #666;
    }
    
    .test-error {
      color: #f44336;
      font-family: monospace;
      font-size: 0.85em;
      margin-top: 5px;
      padding: 5px;
      background: #ffe6e6;
      border-radius: 3px;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .summary {
      font-size: 1.2em;
      font-weight: bold;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    
    .summary.success {
      background: #4CAF50;
      color: white;
    }
    
    .summary.failure {
      background: #f44336;
      color: white;
    }
    
    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #2196F3;
      margin: 15px 0;
    }
    
    .file-input-area {
      margin: 15px 0;
      padding: 15px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      text-align: center;
    }
    
    input[type="file"] {
      margin: 10px 0;
    }
    
    input[type="text"],
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª å¹³å°é€‚é…å™¨æ¨¡å—æµ‹è¯•</h1>
  
  <div class="info-box">
    <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>
    <p>æœ¬é¡µé¢æµ‹è¯•ä¸‰ä¸ªå¹³å°é€‚é…å™¨æ¨¡å—çš„åŠŸèƒ½ï¼š</p>
    <ul>
      <li><strong>PlatformDetector</strong> - å¹³å°æ£€æµ‹ï¼ˆElectron vs Webï¼‰</li>
      <li><strong>ConfigStorage</strong> - é…ç½®å­˜å‚¨ï¼ˆlocalStorageï¼‰</li>
      <li><strong>FileHandler</strong> - æ–‡ä»¶å¤„ç†ï¼ˆè¯»å–ã€ä¿å­˜ã€éªŒè¯ï¼‰</li>
    </ul>
  </div>
  
  <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
  <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
  
  <div id="results"></div>

  <script type="module">
    import { PlatformDetector } from './src/adapters/platform-detector.js';
    import { ConfigStorage, getConfigStorage } from './src/adapters/config-storage.js';
    import { FileHandler, getFileHandler } from './src/adapters/file-handler.js';
    
    // å…¨å±€æµ‹è¯•ç»“æœ
    let testResults = [];
    
    // æµ‹è¯•å·¥å…·å‡½æ•°
    function assert(condition, message) {
      if (!condition) {
        throw new Error(message || 'æ–­è¨€å¤±è´¥');
      }
    }
    
    function assertEqual(actual, expected, message) {
      if (actual !== expected) {
        throw new Error(`${message || 'å€¼ä¸ç›¸ç­‰'}: æœŸæœ› ${expected}, å®é™… ${actual}`);
      }
    }
    
    function assertNotNull(value, message) {
      if (value === null || value === undefined) {
        throw new Error(message || 'å€¼ä¸åº”ä¸º null æˆ– undefined');
      }
    }
    
    // è¿è¡Œå•ä¸ªæµ‹è¯•
    async function runTest(name, testFn) {
      const result = {
        name,
        pass: false,
        error: null,
        startTime: Date.now()
      };
      
      try {
        await testFn();
        result.pass = true;
      } catch (error) {
        result.pass = false;
        result.error = error.message;
        console.error(`æµ‹è¯•å¤±è´¥: ${name}`, error);
      }
      
      result.duration = Date.now() - result.startTime;
      testResults.push(result);
      return result;
    }
    
    // ========== PlatformDetector æµ‹è¯• ==========
    
    async function testPlatformDetection() {
      await runTest('1. å¹³å°æ£€æµ‹ - isElectron()', () => {
        const isElectron = PlatformDetector.isElectron();
        assert(typeof isElectron === 'boolean', 'isElectron() åº”è¿”å›å¸ƒå°”å€¼');
        console.log('å½“å‰å¹³å°æ˜¯å¦ä¸º Electron:', isElectron);
      });
      
      await runTest('2. å¹³å°æ£€æµ‹ - isWeb()', () => {
        const isWeb = PlatformDetector.isWeb();
        assert(typeof isWeb === 'boolean', 'isWeb() åº”è¿”å›å¸ƒå°”å€¼');
        console.log('å½“å‰å¹³å°æ˜¯å¦ä¸º Web:', isWeb);
      });
      
      await runTest('3. å¹³å°æ£€æµ‹ - äº’æ–¥æ€§éªŒè¯', () => {
        const isElectron = PlatformDetector.isElectron();
        const isWeb = PlatformDetector.isWeb();
        assert(isElectron !== isWeb, 'isElectron å’Œ isWeb å¿…é¡»äº’æ–¥');
      });
      
      await runTest('4. å¹³å°ä¿¡æ¯ - getPlatform()', () => {
        const platform = PlatformDetector.getPlatform();
        assert(['electron', 'web'].includes(platform), 'å¹³å°ç±»å‹å¿…é¡»æ˜¯ electron æˆ– web');
        console.log('å½“å‰å¹³å°:', platform);
      });
      
      await runTest('5. å¹³å°ä¿¡æ¯ - getPlatformInfo()', () => {
        const info = PlatformDetector.getPlatformInfo();
        assertNotNull(info.platform, 'å¹³å°ä¿¡æ¯åº”åŒ…å« platform å­—æ®µ');
        assertNotNull(info.userAgent, 'å¹³å°ä¿¡æ¯åº”åŒ…å« userAgent å­—æ®µ');
        assertNotNull(info.features, 'å¹³å°ä¿¡æ¯åº”åŒ…å« features å­—æ®µ');
        console.log('å¹³å°è¯¦ç»†ä¿¡æ¯:', info);
      });
      
      await runTest('6. åŠŸèƒ½æ£€æµ‹ - localStorage', () => {
        const hasLocalStorage = PlatformDetector.hasFeature('localStorage');
        assert(hasLocalStorage === true, 'å½“å‰ç¯å¢ƒåº”æ”¯æŒ localStorage');
      });
      
      await runTest('7. åŠŸèƒ½æ£€æµ‹ - audioContext', () => {
        const hasAudioContext = PlatformDetector.hasFeature('audioContext');
        assert(typeof hasAudioContext === 'boolean', 'hasFeature() åº”è¿”å›å¸ƒå°”å€¼');
        console.log('æ˜¯å¦æ”¯æŒ AudioContext:', hasAudioContext);
      });
      
      await runTest('8. åŠŸèƒ½æ£€æµ‹ - fileAPI', () => {
        const hasFileAPI = PlatformDetector.hasFeature('fileAPI');
        assert(hasFileAPI === true, 'å½“å‰ç¯å¢ƒåº”æ”¯æŒ File API');
      });
    }
    
    // ========== ConfigStorage æµ‹è¯• ==========
    
    async function testConfigStorage() {
      const storage = getConfigStorage();
      
      await runTest('9. é…ç½®å­˜å‚¨ - å•ä¾‹æ¨¡å¼', () => {
        const storage1 = getConfigStorage();
        const storage2 = getConfigStorage();
        assert(storage1 === storage2, 'getConfigStorage() åº”è¿”å›åŒä¸€ä¸ªå®ä¾‹');
      });
      
      await runTest('10. é…ç½®å­˜å‚¨ - set() å’Œ get()', () => {
        storage.set('test-key', 'test-value');
        const value = storage.get('test-key');
        assertEqual(value, 'test-value', 'get() åº”è¿”å› set() è®¾ç½®çš„å€¼');
      });
      
      await runTest('11. é…ç½®å­˜å‚¨ - get() é»˜è®¤å€¼', () => {
        const value = storage.get('non-existent-key', 'default');
        assertEqual(value, 'default', 'get() åº”è¿”å›é»˜è®¤å€¼');
      });
      
      await runTest('12. é…ç½®å­˜å‚¨ - å­˜å‚¨å¯¹è±¡', () => {
        const obj = { foo: 'bar', num: 42 };
        storage.set('test-object', obj);
        const retrieved = storage.get('test-object');
        assertEqual(retrieved.foo, 'bar', 'å¯¹è±¡å±æ€§åº”ä¿æŒä¸€è‡´');
        assertEqual(retrieved.num, 42, 'æ•°å­—å±æ€§åº”ä¿æŒä¸€è‡´');
      });
      
      await runTest('13. é…ç½®å­˜å‚¨ - å­˜å‚¨æ•°ç»„', () => {
        const arr = [1, 2, 3, 'test'];
        storage.set('test-array', arr);
        const retrieved = storage.get('test-array');
        assertEqual(retrieved.length, 4, 'æ•°ç»„é•¿åº¦åº”ä¿æŒä¸€è‡´');
        assertEqual(retrieved[3], 'test', 'æ•°ç»„å…ƒç´ åº”ä¿æŒä¸€è‡´');
      });
      
      await runTest('14. é…ç½®å­˜å‚¨ - remove()', () => {
        storage.set('to-remove', 'value');
        storage.remove('to-remove');
        const value = storage.get('to-remove', null);
        assertEqual(value, null, 'remove() å get() åº”è¿”å›é»˜è®¤å€¼');
      });
      
      await runTest('15. é…ç½®å­˜å‚¨ - getAll()', () => {
        storage.set('key1', 'value1');
        storage.set('key2', 'value2');
        const all = storage.getAll();
        assertNotNull(all, 'getAll() åº”è¿”å›å¯¹è±¡');
        assertEqual(all.key1, 'value1', 'getAll() åº”åŒ…å«æ‰€æœ‰é…ç½®');
        assertEqual(all.key2, 'value2', 'getAll() åº”åŒ…å«æ‰€æœ‰é…ç½®');
      });
      
      await runTest('16. é…ç½®å­˜å‚¨ - setAll()', () => {
        const config = {
          setting1: 'value1',
          setting2: 42,
          setting3: true
        };
        storage.setAll(config);
        assertEqual(storage.get('setting1'), 'value1', 'setAll() åº”è®¾ç½®æ‰€æœ‰é…ç½®');
        assertEqual(storage.get('setting2'), 42, 'setAll() åº”è®¾ç½®æ‰€æœ‰é…ç½®');
        assertEqual(storage.get('setting3'), true, 'setAll() åº”è®¾ç½®æ‰€æœ‰é…ç½®');
      });
      
      await runTest('17. é…ç½®å­˜å‚¨ - clear()', () => {
        storage.set('key-to-clear', 'value');
        storage.clear();
        const value = storage.get('key-to-clear', null);
        assertEqual(value, null, 'clear() åæ‰€æœ‰é…ç½®åº”è¢«æ¸…é™¤');
      });
    }
    
    // ========== FileHandler æµ‹è¯• ==========
    
    async function testFileHandler() {
      const handler = getFileHandler();
      
      await runTest('18. æ–‡ä»¶å¤„ç† - å•ä¾‹æ¨¡å¼', () => {
        const handler1 = getFileHandler();
        const handler2 = getFileHandler();
        assert(handler1 === handler2, 'getFileHandler() åº”è¿”å›åŒä¸€ä¸ªå®ä¾‹');
      });
      
      await runTest('19. æ–‡ä»¶å¤„ç† - validateFileType() - éŸ³é¢‘æ–‡ä»¶', () => {
        const mockFile = { name: 'test.mp3', type: 'audio/mp3', size: 1024 };
        const isValid = handler.validateFileType(mockFile, ['audio/']);
        assert(isValid === true, 'MP3 æ–‡ä»¶åº”é€šè¿‡éŸ³é¢‘ç±»å‹éªŒè¯');
      });
      
      await runTest('20. æ–‡ä»¶å¤„ç† - validateFileType() - ç²¾ç¡®åŒ¹é…', () => {
        const mockFile = { name: 'test.mp3', type: 'audio/mp3', size: 1024 };
        const isValid = handler.validateFileType(mockFile, ['audio/mp3']);
        assert(isValid === true, 'MP3 æ–‡ä»¶åº”é€šè¿‡ç²¾ç¡®ç±»å‹éªŒè¯');
      });
      
      await runTest('21. æ–‡ä»¶å¤„ç† - validateFileType() - ä¸åŒ¹é…', () => {
        const mockFile = { name: 'test.txt', type: 'text/plain', size: 1024 };
        const isValid = handler.validateFileType(mockFile, ['audio/']);
        assert(isValid === false, 'æ–‡æœ¬æ–‡ä»¶ä¸åº”é€šè¿‡éŸ³é¢‘ç±»å‹éªŒè¯');
      });
      
      await runTest('22. æ–‡ä»¶å¤„ç† - validateFileSize() - æ­£å¸¸å¤§å°', () => {
        const mockFile = { name: 'test.mp3', size: 10 * 1024 * 1024 }; // 10MB
        const isValid = handler.validateFileSize(mockFile, 100);
        assert(isValid === true, '10MB æ–‡ä»¶åº”é€šè¿‡ 100MB å¤§å°é™åˆ¶');
      });
      
      await runTest('23. æ–‡ä»¶å¤„ç† - validateFileSize() - è¶…è¿‡é™åˆ¶', () => {
        const mockFile = { name: 'test.mp3', size: 150 * 1024 * 1024 }; // 150MB
        const isValid = handler.validateFileSize(mockFile, 100);
        assert(isValid === false, '150MB æ–‡ä»¶ä¸åº”é€šè¿‡ 100MB å¤§å°é™åˆ¶');
      });
      
      await runTest('24. æ–‡ä»¶å¤„ç† - getFileInfo()', () => {
        const mockFile = {
          name: 'test.mp3',
          size: 1024000,
          type: 'audio/mp3',
          lastModified: Date.now()
        };
        const info = handler.getFileInfo(mockFile);
        assertEqual(info.name, 'test.mp3', 'æ–‡ä»¶ååº”æ­£ç¡®');
        assertEqual(info.size, 1024000, 'æ–‡ä»¶å¤§å°åº”æ­£ç¡®');
        assertEqual(info.type, 'audio/mp3', 'æ–‡ä»¶ç±»å‹åº”æ­£ç¡®');
        assertNotNull(info.lastModifiedDate, 'åº”åŒ…å«ä¿®æ”¹æ—¥æœŸ');
      });
    }
    
    // ========== äº¤äº’å¼æµ‹è¯• ==========
    
    async function testFileRead() {
      await runTest('25. æ–‡ä»¶å¤„ç† - è¯»å–æ–‡ä»¶ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰', async () => {
        // è¿™ä¸ªæµ‹è¯•éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
        console.log('æ­¤æµ‹è¯•éœ€è¦åœ¨äº¤äº’å¼åŒºåŸŸæ‰‹åŠ¨è§¦å‘');
      });
    }
    
    async function testFileSave() {
      await runTest('26. æ–‡ä»¶å¤„ç† - ä¿å­˜æ–‡ä»¶ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰', async () => {
        // è¿™ä¸ªæµ‹è¯•éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
        console.log('æ­¤æµ‹è¯•éœ€è¦åœ¨äº¤äº’å¼åŒºåŸŸæ‰‹åŠ¨è§¦å‘');
      });
    }
    
    // ========== ä¸»æµ‹è¯•å‡½æ•° ==========
    
    async function runAllTests() {
      testResults = [];
      document.getElementById('results').innerHTML = '<p>â³ æ­£åœ¨è¿è¡Œæµ‹è¯•...</p>';
      
      // è¿è¡Œæ‰€æœ‰æµ‹è¯•ç»„
      await testPlatformDetection();
      await testConfigStorage();
      await testFileHandler();
      
      // æ˜¾ç¤ºç»“æœ
      displayResults();
    }
    
    function displayResults() {
      const container = document.getElementById('results');
      const passed = testResults.filter(r => r.pass).length;
      const failed = testResults.filter(r => !r.pass).length;
      const total = testResults.length;
      
      let html = `
        <div class="summary ${failed === 0 ? 'success' : 'failure'}">
          æµ‹è¯•å®Œæˆ: ${passed}/${total} é€šè¿‡ ${failed > 0 ? `(${failed} å¤±è´¥)` : 'âœ“'}
        </div>
      `;
      
      // æŒ‰åˆ†ç»„æ˜¾ç¤ºæµ‹è¯•ç»“æœ
      const groups = [
        { title: 'PlatformDetector æµ‹è¯•', range: [1, 8] },
        { title: 'ConfigStorage æµ‹è¯•', range: [9, 17] },
        { title: 'FileHandler æµ‹è¯•', range: [18, 24] }
      ];
      
      groups.forEach(group => {
        html += `<div class="test-section"><h2>${group.title}</h2>`;
        
        testResults
          .filter(r => {
            const num = parseInt(r.name.split('.')[0]);
            return num >= group.range[0] && num <= group.range[1];
          })
          .forEach(result => {
            html += `
              <div class="test-case ${result.pass ? 'pass' : 'fail'}">
                <div class="test-name">${result.pass ? 'âœ…' : 'âŒ'} ${result.name}</div>
                <div class="test-result">è€—æ—¶: ${result.duration}ms</div>
                ${result.error ? `<div class="test-error">é”™è¯¯: ${result.error}</div>` : ''}
              </div>
            `;
          });
        
        html += '</div>';
      });
      
      container.innerHTML = html;
    }
    
    function clearResults() {
      testResults = [];
      document.getElementById('results').innerHTML = '';
    }
    
    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä½¿ onclick å¯ä»¥è®¿é—®
    window.runAllTests = runAllTests;
    window.clearResults = clearResults;
    
  </script>
</body>
</html>